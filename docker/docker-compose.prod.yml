# ==========================================
# ğŸš€ CodeHubot ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²é…ç½®
# ==========================================
# 
# âš ï¸ å®‰å…¨è­¦å‘Šï¼š
# 1. å¿…é¡»é…ç½® .env æ–‡ä»¶ä¸­çš„æ‰€æœ‰å¯†é’¥å’Œå¯†ç 
# 2. ä¸è¦ä½¿ç”¨é»˜è®¤å€¼éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
# 3. ç¡®ä¿ä»¥ä¸‹ç¯å¢ƒå˜é‡å·²æ­£ç¡®è®¾ç½®ï¼š
#    - SECRET_KEY (JWTå¯†é’¥ï¼Œå¿…é¡»å¼ºå¯†é’¥)
#    - INTERNAL_API_KEY (å†…éƒ¨æœåŠ¡APIå¯†é’¥)
#    - MYSQL_PASSWORD (æ•°æ®åº“å¯†ç )
#    - MYSQL_ROOT_PASSWORD (æ•°æ®åº“Rootå¯†ç )
#    - DASHSCOPE_API_KEY (é˜¿é‡Œäº‘AIå¯†é’¥)
#
# ç”Ÿæˆå¼ºå¯†é’¥å‘½ä»¤ï¼š
#   python3 -c "import secrets; print(secrets.token_urlsafe(32))"
#
# ==========================================

services:
  # MySQLæ•°æ®åº“
  mysql:
    image: mysql:8.0
    container_name: codehubot-mysql
    environment:
      MYSQL_DATABASE: ${MYSQL_DATABASE:-aiot_admin}
      MYSQL_USER: ${MYSQL_USER:-aiot_user}
      # âš ï¸ ç”Ÿäº§ç¯å¢ƒå¿…é¡»åœ¨ .env æ–‡ä»¶ä¸­è®¾ç½®å¼ºå¯†ç ï¼
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-aiot_password}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root_password}
    volumes:
      - mysql_data:/var/lib/mysql
      - ../SQL/01_init_database.sql:/docker-entrypoint-initdb.d/01_init_database.sql:ro
      - ../SQL/02_init_data.sql:/docker-entrypoint-initdb.d/02_init_data.sql:ro
    # ä¸æš´éœ²ç«¯å£åˆ°å¤–éƒ¨ï¼Œä»…åœ¨Dockerç½‘ç»œå†…éƒ¨è®¿é—®ï¼ˆå®‰å…¨è€ƒè™‘ï¼‰
    # ports:
    #   - "${MYSQL_PORT:-3306}:3306"
    command: --default-authentication-plugin=mysql_native_password --innodb-use-native-aio=0 --log-bin-trust-function-creators=1
    networks:
      - aiot-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD:-root_password}"]
      interval: 30s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Redisç¼“å­˜æœåŠ¡
  redis:
    image: redis:7-alpine
    container_name: codehubot-redis
    # ä¸æš´éœ²ç«¯å£åˆ°å¤–éƒ¨ï¼Œä»…åœ¨Dockerç½‘ç»œå†…éƒ¨è®¿é—®ï¼ˆå®‰å…¨è€ƒè™‘ï¼‰
    # ports:
    #   - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    networks:
      - aiot-network
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 3s
      retries: 5
    restart: unless-stopped

  # MQTTæœåŠ¡
  mqtt:
    image: eclipse-mosquitto:2.0
    container_name: codehubot-mqtt
    ports:
      - "${MQTT_BROKER_PORT:-1883}:1883"
      - "${MQTT_WS_PORT:-9001}:9001"
    volumes:
      - ./mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
      - mqtt_data:/mosquitto/data
      - mqtt_logs:/mosquitto/log
    networks:
      - aiot-network
    healthcheck:
      test: ["CMD", "mosquitto_pub", "-h", "localhost", "-t", "health/check", "-m", "ping", "-i", "health-check-client"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  # åç«¯æœåŠ¡
  backend:
    build:
      context: ../backend
      dockerfile: Dockerfile
      args:
        USE_CHINA_MIRROR: ${USE_CHINA_MIRROR:-true}
        PIP_INDEX_URL: ${PIP_INDEX_URL:-}
        PIP_TRUSTED_HOST: ${PIP_TRUSTED_HOST:-}
    container_name: codehubot-backend
    environment:
      # æ•°æ®åº“é…ç½®
      DB_HOST: mysql
      DB_PORT: 3306
      DB_USER: ${MYSQL_USER:-aiot_user}
      # âš ï¸ ç”Ÿäº§ç¯å¢ƒå¿…é¡»åœ¨ .env æ–‡ä»¶ä¸­è®¾ç½®å¼ºå¯†ç ï¼
      DB_PASSWORD: ${MYSQL_PASSWORD:-aiot_password}
      DB_NAME: ${MYSQL_DATABASE:-aiot_admin}
      # Redisé…ç½®
      REDIS_URL: redis://redis:6379
      # é˜¿é‡Œäº‘APIå¯†é’¥ï¼ˆå‘é‡åŒ–éœ€è¦ï¼‰
      DASHSCOPE_API_KEY: ${DASHSCOPE_API_KEY}
      # é˜¿é‡Œäº‘VODé…ç½®ï¼ˆè§†é¢‘ç‚¹æ’­ï¼‰
      # æœåŠ¡å™¨é…ç½®
      SERVER_BASE_URL: ${SERVER_BASE_URL:-http://localhost:8000}
      # JWTé…ç½®
      # âš ï¸ ç”Ÿäº§ç¯å¢ƒå¿…é¡»åœ¨ .env æ–‡ä»¶ä¸­è®¾ç½®å¼ºå¯†é’¥ï¼
      # ç”Ÿæˆå‘½ä»¤ï¼špython3 -c "import secrets; print(secrets.token_urlsafe(32))"
      SECRET_KEY: ${SECRET_KEY}
      ALGORITHM: ${ALGORITHM:-HS256}
      ACCESS_TOKEN_EXPIRE_MINUTES: ${ACCESS_TOKEN_EXPIRE_MINUTES:-120}
      REFRESH_TOKEN_EXPIRE_MINUTES: ${REFRESH_TOKEN_EXPIRE_MINUTES:-10080}
      # MQTTé…ç½®
      MQTT_BROKER_HOST: ${MQTT_BROKER_HOST:-mqtt}
      MQTT_BROKER_PORT: 1883
      MQTT_USERNAME: ${MQTT_USERNAME:-}
      MQTT_PASSWORD: ${MQTT_PASSWORD:-}
      # å†…éƒ¨APIå¯†é’¥
      # âš ï¸ ç”Ÿäº§ç¯å¢ƒå¿…é¡»åœ¨ .env æ–‡ä»¶ä¸­è®¾ç½®å¼ºå¯†é’¥ï¼
      # ç”¨äºå†…éƒ¨æœåŠ¡é—´é€šä¿¡è®¤è¯
      INTERNAL_API_KEY: ${INTERNAL_API_KEY}
      # ç¯å¢ƒé…ç½®
      ENVIRONMENT: ${ENVIRONMENT:-production}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      # æ–‡ä»¶å­˜å‚¨è·¯å¾„ï¼ˆä¸å…±äº«å·æŒ‚è½½è·¯å¾„ä¸€è‡´ï¼‰
      KNOWLEDGE_BASE_STORAGE: /app/backend/data/knowledge-bases
      # ç®¡ç†å‘˜è´¦å·é…ç½®ï¼ˆå¯é€‰ï¼Œç”¨äºè‡ªåŠ¨åˆ›å»ºç®¡ç†å‘˜è´¦å·ï¼‰
      ADMIN_USERNAME: ${ADMIN_USERNAME:-admin}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD:-}
      ADMIN_EMAIL: ${ADMIN_EMAIL:-}
      # é»˜è®¤å¤§æ¨¡å‹é…ç½®ï¼ˆé€šä¹‰åƒé—®ï¼‰
      QWEN_API_KEY: ${QWEN_API_KEY:-${DASHSCOPE_API_KEY:-}}
      QWEN_API_BASE: ${QWEN_API_BASE:-https://dashscope.aliyuncs.com/compatible-mode/v1}
      QWEN_MODEL_NAME: ${QWEN_MODEL_NAME:-qwen-turbo}
      QWEN_DISPLAY_NAME: ${QWEN_DISPLAY_NAME:-é€šä¹‰åƒé—®-Turbo}
      QWEN_MAX_TOKENS: ${QWEN_MAX_TOKENS:-8192}
      QWEN_TEMPERATURE: ${QWEN_TEMPERATURE:-0.20}
      QWEN_TOP_P: ${QWEN_TOP_P:-0.90}
      # é»˜è®¤äº§å“é…ç½®ï¼ˆESP32-S3å¼€å‘æ¿ï¼‰
      DEFAULT_PRODUCT_CODE: ${DEFAULT_PRODUCT_CODE:-ESP-32-S3-01}
      DEFAULT_PRODUCT_NAME: ${DEFAULT_PRODUCT_NAME:-æ ‡å‡†å¼€å‘æ¿}
    # ä¸æš´éœ²ç«¯å£åˆ°å¤–éƒ¨ï¼Œä»…é€šè¿‡nginxåå‘ä»£ç†è®¿é—®ï¼ˆå®‰å…¨è€ƒè™‘ï¼‰
    # ports:
    #   - "${BACKEND_PORT:-8000}:8000"
    networks:
      - aiot-network
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
      mqtt:
        condition: service_healthy
    volumes:
      # å…±äº«æ–‡ä»¶å­˜å‚¨å·ï¼ˆçŸ¥è¯†åº“æ–‡æ¡£ï¼‰- ç»Ÿä¸€ä½¿ç”¨backendè·¯å¾„
      - knowledge_bases_data:/app/backend/data/knowledge-bases
      # æ–‡ä»¶ä¸Šä¼ ç›®å½•æŒä¹…åŒ–
      - uploads_data:/app/uploads
      # é™æ€æ–‡ä»¶æŒä¹…åŒ–ï¼ˆå›ºä»¶ã€èµ„æºç­‰ï¼‰
      - static_data:/app/static
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  # MQTTæœåŠ¡ - è®¾å¤‡æ¶ˆæ¯å¤„ç†ï¼ˆç‹¬ç«‹æœåŠ¡ï¼‰
  mqtt-service:
    build:
      context: ../service/mqtt-service
      dockerfile: Dockerfile
    container_name: codehubot-mqtt-service
    environment:
      # MQTT Brokeré…ç½®ï¼ˆmqtt-serviceè¿æ¥åˆ°Brokerï¼Œç»Ÿä¸€å˜é‡åï¼‰
      MQTT_BROKER_HOST: ${MQTT_BROKER_HOST:-mqtt}
      MQTT_BROKER_PORT: 1883
      MQTT_USERNAME: ${MQTT_USERNAME:-}
      MQTT_PASSWORD: ${MQTT_PASSWORD:-}
      # æ•°æ®åº“é…ç½®
      DB_HOST: mysql
      DB_PORT: 3306
      DB_USER: ${MYSQL_USER:-aiot_user}
      DB_PASSWORD: ${MYSQL_PASSWORD:-aiot_password}
      DB_NAME: ${MYSQL_DATABASE:-aiot_admin}
    networks:
      - aiot-network
    depends_on:
      mysql:
        condition: service_healthy
      mqtt:
        condition: service_healthy
    restart: unless-stopped

  # Celery Worker - å¼‚æ­¥ä»»åŠ¡å¤„ç†ï¼ˆç‹¬ç«‹æœåŠ¡ï¼‰
  celery_worker:
    build:
      context: ..
      dockerfile: service/celery-service/Dockerfile
    container_name: codehubot-celery-worker
    environment:
      # Redisé…ç½®
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      REDIS_DB: 0
      # æ•°æ®åº“é…ç½®
      DB_HOST: mysql
      DB_PORT: 3306
      DB_USER: ${MYSQL_USER:-aiot_user}
      DB_PASSWORD: ${MYSQL_PASSWORD:-aiot_password}
      DB_NAME: ${MYSQL_DATABASE:-aiot_admin}
      # JWTå¯†é’¥
      SECRET_KEY: ${SECRET_KEY}
      # MQTTé…ç½®
      MQTT_BROKER_HOST: ${MQTT_BROKER_HOST:-mqtt}
      MQTT_BROKER_PORT: 1883
      MQTT_USERNAME: ${MQTT_USERNAME:-}
      MQTT_PASSWORD: ${MQTT_PASSWORD:-}
      # é˜¿é‡Œäº‘APIå¯†é’¥ï¼ˆå‘é‡åŒ–éœ€è¦ï¼‰
      DASHSCOPE_API_KEY: ${DASHSCOPE_API_KEY}
      # æ–‡ä»¶å­˜å‚¨è·¯å¾„ï¼ˆä¸å…±äº«å·æŒ‚è½½è·¯å¾„ä¸€è‡´ï¼‰
      KNOWLEDGE_BASE_STORAGE: /app/backend/data/knowledge-bases
    volumes:
      # å…±äº«æ–‡ä»¶å­˜å‚¨å·ï¼ˆçŸ¥è¯†åº“æ–‡æ¡£ï¼‰- ä¸backendå…±äº«
      - knowledge_bases_data:/app/backend/data/knowledge-bases
    networks:
      - aiot-network
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped

  # Flower - Celeryä»»åŠ¡ç›‘æ§é¢æ¿ï¼ˆç‹¬ç«‹æœåŠ¡ï¼‰
  flower:
    build:
      context: ..
      dockerfile: service/celery-service/Dockerfile
    container_name: codehubot-flower
    command: ["bash", "start_flower.sh"]
    ports:
      - "${FLOWER_PORT:-5555}:5555"
    environment:
      # Redisé…ç½®
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      REDIS_DB: 0
      # æ•°æ®åº“é…ç½®
      DB_HOST: mysql
      DB_PORT: 3306
      DB_USER: ${MYSQL_USER:-aiot_user}
      DB_PASSWORD: ${MYSQL_PASSWORD:-aiot_password}
      DB_NAME: ${MYSQL_DATABASE:-aiot_admin}
      # JWTå¯†é’¥
      SECRET_KEY: ${SECRET_KEY}
      # MQTTé…ç½®
      MQTT_BROKER_HOST: ${MQTT_BROKER_HOST:-mqtt}
      MQTT_BROKER_PORT: 1883
      MQTT_USERNAME: ${MQTT_USERNAME:-}
      MQTT_PASSWORD: ${MQTT_PASSWORD:-}
      # Floweré…ç½®
      FLOWER_PORT: 5555
      FLOWER_BASIC_AUTH: ${FLOWER_BASIC_AUTH:-admin:admin}
    networks:
      - aiot-network
    depends_on:
      - redis
      - celery_worker
    restart: unless-stopped

  # é…ç½®æœåŠ¡
  config-service:
    build:
      context: ../service/config-service
      dockerfile: Dockerfile
      args:
        USE_CHINA_MIRROR: ${USE_CHINA_MIRROR:-true}
        PIP_INDEX_URL: ${PIP_INDEX_URL:-}
        PIP_TRUSTED_HOST: ${PIP_TRUSTED_HOST:-}
    container_name: codehubot-config-service
    environment:
      # æ•°æ®åº“é…ç½®
      DB_HOST: mysql
      DB_PORT: 3306
      DB_USER: ${MYSQL_USER:-aiot_user}
      DB_PASSWORD: ${MYSQL_PASSWORD:-aiot_password}
      DB_NAME: ${MYSQL_DATABASE:-aiot_admin}
      # è®¾å¤‡MQTTé…ç½®å·²è¿ç§»åˆ°æ•°æ®åº“ç®¡ç†ï¼Œé€šè¿‡ç³»ç»Ÿé…ç½®é¡µé¢è¿›è¡Œé…ç½®
      # åç«¯æœåŠ¡åœ°å€ï¼ˆç”¨äºå†…éƒ¨è°ƒç”¨ï¼‰
      API_SERVER: ${BACKEND_URL:-http://backend:8000}
      OTA_SERVER: ${BACKEND_URL:-http://backend:8000}
      # ç¯å¢ƒé…ç½®
      ENVIRONMENT: ${ENVIRONMENT:-production}
    ports:
      - "${CONFIG_SERVICE_PORT:-8001}:8001"
    networks:
      - aiot-network
    depends_on:
      mysql:
        condition: service_healthy
      mqtt:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8001/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  # å‰ç«¯æœåŠ¡
  frontend:
    build:
      context: ../frontend
      dockerfile: Dockerfile
    container_name: codehubot-frontend
    ports:
      - "${FRONTEND_PORT:-80}:80"
    networks:
      - aiot-network
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # æ’ä»¶åç«¯æœåŠ¡ï¼ˆç›´æ¥è®¿é—®æ•°æ®åº“å’ŒMQTTï¼‰
  plugin-backend-service:
    build:
      context: ../service/plugin-backend-service
      dockerfile: Dockerfile
    container_name: codehubot-plugin-backend-service
    environment:
      # æœåŠ¡é…ç½®
      SERVICE_PORT: 9002
      SERVICE_HOST: 0.0.0.0
      # æ•°æ®åº“é…ç½® - ä½¿ç”¨å†…ç½®MySQL
      DB_HOST: mysql
      DB_PORT: 3306
      DB_USER: ${MYSQL_USER:-aiot_user}
      DB_PASSWORD: ${MYSQL_PASSWORD:-aiot_password}
      DB_NAME: ${MYSQL_DATABASE:-aiot_admin}
      # MQTTé…ç½®
      MQTT_BROKER_HOST: mqtt
      MQTT_BROKER_PORT: 1883
      MQTT_USERNAME: ${MQTT_USERNAME:-}
      MQTT_PASSWORD: ${MQTT_PASSWORD:-}
    # ä¸æš´éœ²ç«¯å£åˆ°å¤–éƒ¨,ä»…åœ¨Dockerç½‘ç»œå†…éƒ¨è®¿é—®
    # ports:
    #   - "9002:9002"
    networks:
      - aiot-network
    depends_on:
      mysql:
        condition: service_healthy
      mqtt:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:9002/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  # æ’ä»¶æœåŠ¡ï¼ˆæ¥æ”¶å¤–éƒ¨è¯·æ±‚ï¼‰
  plugin-service:
    build:
      context: ../service/plugin-service
      dockerfile: Dockerfile
      args:
        USE_CHINA_MIRROR: ${USE_CHINA_MIRROR:-true}
        PIP_INDEX_URL: ${PIP_INDEX_URL:-}
        PIP_TRUSTED_HOST: ${PIP_TRUSTED_HOST:-}
    container_name: codehubot-plugin-service
    environment:
      # æœåŠ¡é…ç½®
      PORT: ${PLUGIN_SERVICE_PORT:-9000}
      HOST: 0.0.0.0
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      RELOAD: "false"
      # åç«¯æœåŠ¡é…ç½®
      PLUGIN_BACKEND_URL: http://plugin-backend-service:9002
      BACKEND_URL: ${BACKEND_URL:-http://backend:8000}
      BACKEND_API_KEY: ${INTERNAL_API_KEY}
      # å®‰å…¨é…ç½®
      CORS_ENABLED: ${PLUGIN_CORS_ENABLED:-true}
      CORS_ORIGINS: ${PLUGIN_CORS_ORIGINS:-*}
      # å…¶ä»–é…ç½®
      REQUEST_TIMEOUT: ${PLUGIN_REQUEST_TIMEOUT:-30}
      DEBUG_MODE: ${PLUGIN_DEBUG_MODE:-false}
    ports:
      - "${PLUGIN_SERVICE_PORT:-9000}:9000"
    networks:
      - aiot-network
    depends_on:
      backend:
        condition: service_healthy
      plugin-backend-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:9000/')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  # phpMyAdmin æ•°æ®åº“ç®¡ç†å·¥å…·
  phpmyadmin:
    image: phpmyadmin/phpmyadmin:latest
    container_name: codehubot-phpmyadmin
    environment:
      PMA_HOST: mysql
      PMA_PORT: 3306
      # å…è®¸ä»»æ„æœåŠ¡å™¨è¿æ¥ï¼ˆä¸é¢„å¡«å¯†ç ï¼‰
      PMA_ARBITRARY: 1
      # ä¸Šä¼ å¤§å°é™åˆ¶
      UPLOAD_LIMIT: 50M
      # éšè—æ•°æ®åº“ï¼ˆå¯é€‰ï¼Œæé«˜å®‰å…¨æ€§ï¼‰
      # PMA_HIDE_DB: information_schema|performance_schema|mysql|sys
    ports:
      - "${PHPMYADMIN_PORT:-8081}:80"
    networks:
      - aiot-network
    depends_on:
      mysql:
        condition: service_healthy
    restart: unless-stopped

volumes:
  mysql_data:
  redis_data:
  mqtt_data:
  mqtt_logs:
  knowledge_bases_data:  # çŸ¥è¯†åº“æ–‡æ¡£å…±äº«å­˜å‚¨å·
  uploads_data:          # ä¸Šä¼ æ–‡ä»¶å­˜å‚¨å·
  static_data:           # é™æ€æ–‡ä»¶å­˜å‚¨å·ï¼ˆå›ºä»¶ã€èµ„æºç­‰ï¼‰

networks:
  aiot-network:
    driver: bridge

