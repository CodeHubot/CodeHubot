# 🎯 如何使用固件烧录功能

## 📌 功能位置

固件烧录功能已集成到设备管理系统中，可以通过以下方式访问：

### 方式 1：直接访问
```
http://localhost:3000/device/firmware-flasher
```

### 方式 2：通过菜单访问
1. 登录系统
2. 进入"设备管理"模块
3. 在左侧菜单中找到"固件烧录"选项（在"设备授权"下方）
4. 点击进入固件烧录页面

## 🚀 开始使用

### 前置准备

#### 1. 安装前端依赖（首次使用）

```bash
cd frontend
npm install
```

这会自动安装 `esptool-js` 及其他必需依赖。

#### 2. 启动开发服务器

```bash
npm run dev
```

服务将在 `http://localhost:3000` 启动。

#### 3. 浏览器要求

**必须使用以下浏览器之一：**
- ✅ Google Chrome（推荐，版本 89+）
- ✅ Microsoft Edge（版本 89+）
- ✅ Opera（版本 75+）

**不支持的浏览器：**
- ❌ Firefox（不支持 Web Serial API）
- ❌ Safari（不支持 Web Serial API）
- ❌ 移动端浏览器

#### 4. 硬件准备

- ESP32 设备（ESP32-S3、ESP32-C3 等）
- USB **数据线**（非充电线，必须支持数据传输）
- 确保驱动已安装（CH340 或 CP210x）

## 📝 使用步骤

### 第一步：连接设备

1. 使用 USB 数据线将 ESP32 设备连接到电脑
2. 打开固件烧录页面
3. 点击"连接设备"按钮
4. 在弹出的串口选择对话框中：
   - Windows: 选择 `COM3`、`COM4` 等
   - macOS: 选择 `/dev/cu.usbserial-xxx` 或 `/dev/cu.wchusbserial-xxx`
   - Linux: 选择 `/dev/ttyUSB0` 或 `/dev/ttyACM0`
5. 等待连接成功

**成功标志：**
- 状态卡片显示"已连接 - ESP32-S3"（或其他芯片型号）
- 状态指示灯变为绿色
- 日志显示"✅ 连接成功！"
- 弹出成功提示消息

### 第二步：选择固件

1. 在"选择固件版本"下拉框中选择要烧录的固件
2. 查看固件详细信息：
   - 固件名称
   - 版本号
   - 发布日期
   - 文件大小
   - 功能描述

**当前可用固件：**
- ESP32-S3-Lite v1.6（约 6 MB）

### 第三步：开始烧录

1. 确认设备已连接且固件已选择
2. 点击"开始烧录"按钮
3. 观察烧录过程：
   - 进度条实时更新（0% → 100%）
   - 日志显示烧录进度
   - 按钮显示"烧录中..."
4. 等待烧录完成（通常需要 2-3 分钟）

**完成标志：**
- 进度条达到 100%
- 日志显示"🎉 固件烧录完成！"
- 设备自动重启
- 弹出成功提示消息

### 第四步：验证固件

烧录完成后，设备会自动重启。可以通过以下方式验证：
1. 观察设备 LED 指示灯
2. 连接串口监视器查看输出
3. 测试设备功能

## 🔧 其他功能

### 擦除 Flash

如果需要完全清空设备的 Flash 存储：

1. 确保设备已连接
2. 点击"擦除 Flash"按钮
3. 在警告对话框中点击"确定擦除"
4. 等待擦除完成

⚠️ **警告：此操作不可恢复，会删除设备上的所有数据！**

**适用场景：**
- 烧录失败后重试
- 更换固件类型
- 设备出现异常需要重置

### 重启设备

手动重启已连接的设备：

1. 确保设备已连接
2. 点击"重启设备"按钮
3. 设备会立即重启

**适用场景：**
- 烧录完成后需要重新初始化
- 测试设备启动流程
- 设备无响应时尝试恢复

### 断开连接

完成操作后断开与设备的连接：

1. 点击"断开连接"按钮
2. 状态卡片更新为"未连接设备"
3. 可以拔掉 USB 线或连接其他设备

## 📊 界面说明

### 1. 状态卡片
- 显示设备连接状态
- 显示芯片型号信息
- 状态指示灯（红色=未连接，绿色=已连接）

### 2. 连接控制
- "连接设备"按钮：请求串口访问并连接设备
- "断开连接"按钮：断开当前连接

### 3. 固件选择
- 下拉框：选择固件版本
- 信息面板：显示固件详细信息

### 4. 操作按钮
- "开始烧录"：烧录选定的固件
- "擦除 Flash"：完全擦除设备 Flash
- "重启设备"：重启已连接的设备

### 5. 进度显示
- 烧录时显示实时进度条
- 百分比显示（0% - 100%）

### 6. 日志面板
- 显示所有操作的详细日志
- 包含时间戳
- 不同类型用不同颜色标识：
  - 绿色：成功操作
  - 红色：错误信息
  - 橙色：警告信息
  - 灰色：普通信息
- "清空日志"按钮：清除所有日志

### 7. 使用提示
- 浏览器要求
- 连接设备说明
- 选择固件说明
- 开始烧录说明
- 故障排除提示

## ⚠️ 常见问题

### Q1: 点击"连接设备"后没有反应

**可能原因：**
- 浏览器不支持 Web Serial API
- 浏览器版本过低

**解决方案：**
1. 确认使用 Chrome 或 Edge 浏览器
2. 更新浏览器到最新版本
3. 检查浏览器控制台是否有错误信息

### Q2: 串口选择对话框中找不到设备

**可能原因：**
- USB 线为充电线（无数据传输功能）
- 驱动未安装
- 串口被其他程序占用
- USB 连接不良

**解决方案：**
1. 更换 USB 数据线
2. 安装 CH340 或 CP210x 驱动
3. 关闭其他串口程序（Arduino IDE、串口调试助手等）
4. 重新插拔 USB 线
5. 尝试更换 USB 口

### Q3: 连接成功但无法烧录

**可能原因：**
- 固件文件不存在或损坏
- 设备进入了错误的模式

**解决方案：**
1. 检查固件文件是否存在于 `frontend/public/firmware/` 目录
2. 断开连接后重新连接
3. 尝试先"擦除 Flash"再烧录

### Q4: 烧录过程中断

**可能原因：**
- USB 连接不稳定
- 设备断电
- 电脑进入休眠

**解决方案：**
1. 检查 USB 连接是否牢固
2. 使用质量好的 USB 线
3. 更换 USB 口（使用主板直连的 USB 口）
4. 关闭电脑节能模式
5. 重新连接后再次烧录

### Q5: 烧录完成但设备无响应

**可能原因：**
- 固件与硬件不匹配
- 设备未正确重启
- 固件本身有问题

**解决方案：**
1. 确认固件版本与设备型号匹配
2. 手动按设备上的 RESET 按钮
3. 断电后重新上电
4. 尝试烧录其他已知正常的固件

### Q6: 进度条长时间停在某个百分比

**可能原因：**
- 正常现象（大文件烧录需要时间）
- 串口通信异常

**解决方案：**
1. 耐心等待（首次烧录可能需要 3-5 分钟）
2. 如果超过 10 分钟无变化，断开重连后重试
3. 检查系统资源占用（CPU、内存）
4. 关闭其他占用资源的程序

## 💡 使用技巧

### 1. 查看详细日志

日志面板会记录所有操作的详细信息，遇到问题时：
- 仔细阅读错误日志
- 复制日志信息用于问题排查
- 使用"清空日志"保持界面整洁

### 2. 烧录前的准备

为了提高成功率：
- 使用质量好的 USB 数据线
- 确保电脑 USB 口供电充足
- 关闭不必要的串口程序
- 保持设备和电脑连接稳定

### 3. 烧录失败后的处理

如果烧录失败：
1. 不要惊慌，设备不会损坏
2. 先点击"擦除 Flash"
3. 重新连接设备
4. 再次尝试烧录

### 4. 批量烧录

如需烧录多个设备：
1. 烧录完第一个设备
2. 点击"断开连接"
3. 拔掉第一个设备，连接第二个
4. 重复烧录流程

## 📚 进阶使用

### 添加新固件版本

如果需要添加新的固件版本：

1. **上传固件文件**
   ```bash
   cp your-new-firmware.bin frontend/public/firmware/
   ```

2. **更新配置**
   
   编辑 `frontend/src/modules/device/views/FirmwareFlasher.vue`，找到 `firmwareList` 配置（约第 80 行）：

   ```javascript
   const firmwareList = ref([
     // 现有固件...
     {
       id: 'esp32s3-lite-v1.7',              // 唯一标识符
       name: 'ESP32-S3-Lite v1.7',           // 显示名称
       version: '1.7',                        // 版本号
       filename: '/firmware/your-new-firmware.bin', // 文件路径
       size: '约 6.5 MB',                    // 文件大小
       date: '2025-01-15',                    // 发布日期
       description: '新增功能说明',           // 功能描述
       address: '0x0'                         // 烧录地址
     }
   ])
   ```

3. **重启服务**
   ```bash
   # 按 Ctrl+C 停止服务，然后重新启动
   npm run dev
   ```

4. **验证**
   - 刷新浏览器页面
   - 检查固件选择下拉框是否显示新固件

## 🔒 安全注意事项

1. ⚠️ **确认固件来源** - 只使用官方或可信来源的固件
2. ⚠️ **备份数据** - 烧录前备份设备上的重要数据
3. ⚠️ **版本匹配** - 确保固件版本与设备型号匹配
4. ⚠️ **稳定连接** - 烧录过程中保持连接稳定
5. ⚠️ **电源充足** - 确保设备供电充足

## 📞 获取帮助

如果遇到无法解决的问题：

1. 查看 [详细功能说明](./docs/固件烧录功能说明.md)
2. 查看 [安装指南](./docs/固件烧录功能安装指南.md)
3. 检查浏览器控制台（F12）的错误信息
4. 查看日志面板的详细信息
5. 参考 [测试清单](./固件烧录功能测试清单.md)

## 🎉 开始使用

现在你已经了解了如何使用固件烧录功能，开始体验吧！

```bash
# 1. 安装依赖（首次使用）
cd frontend && npm install

# 2. 启动服务
npm run dev

# 3. 打开浏览器
# http://localhost:3000/device/firmware-flasher
```

**祝你使用愉快！** 🚀

