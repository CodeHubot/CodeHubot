-- ==========================================================================================================
-- 添加设备配置服务器地址配置项
-- ==========================================================================================================
-- 
-- 脚本名称: 01_add_device_config_server_url.sql
-- 脚本版本: 1.0.0
-- 创建日期: 2025-01-19
-- 兼容版本: MySQL 5.7.x, 8.0.x
-- 字符集: utf8mb4
-- 排序规则: utf8mb4_unicode_ci
--
-- ==========================================================================================================
-- 脚本说明
-- ==========================================================================================================
--
-- 1. 用途说明:
--    本脚本用于添加设备配置服务器地址配置项（device_config_server_url）
--    该配置项将在设备注册成功后显示给用户，用于设备配网时填写
--
-- 2. 变更内容:
--    - 在 core_system_config 表中添加 device_config_server_url 配置项
--    - 该配置项为公开配置（is_public=1），前端可直接访问
--
-- 3. 执行方式:
--    mysql -h hostname -u username -p --default-character-set=utf8mb4 aiot_admin < 01_add_device_config_server_url.sql
--
-- 4. 可重复执行:
--    ✅ 本脚本使用 INSERT IGNORE，可安全重复执行
--    如果配置项已存在，不会覆盖现有数据
--
-- ==========================================================================================================

SET NAMES utf8mb4 COLLATE utf8mb4_unicode_ci;

SELECT '========================================' AS '';
SELECT '开始添加设备配置服务器地址配置项...' AS '';
SELECT '========================================' AS '';

-- 添加设备配置服务器地址配置项
INSERT IGNORE INTO `core_system_config` 
(`config_key`, `config_value`, `config_type`, `description`, `category`, `is_public`) 
VALUES 
('device_config_server_url', 'http://config.example.com:8001', 'string', '设备配置服务器地址（设备配网时填写，获取MQTT等配置信息）', 'device', 1);

-- 检查是否添加成功
SET @config_exists = (
    SELECT COUNT(*) 
    FROM `core_system_config` 
    WHERE `config_key` = 'device_config_server_url'
);

SELECT 
    CASE 
        WHEN @config_exists > 0 THEN '✓ 设备配置服务器地址配置项添加成功'
        ELSE '✗ 设备配置服务器地址配置项添加失败'
    END AS 'Status';

SELECT '========================================' AS '';
SELECT '脚本执行完成！' AS '';
SELECT '========================================' AS '';

-- ==========================================================================================================
-- 后续操作说明
-- ==========================================================================================================
-- 
-- 配置完成后，请进行以下操作：
--
-- 1. 登录管理后台
--    路径：系统管理 -> MQTT服务器配置
--
-- 2. 修改配置服务器地址
--    将 "device_config_server_url" 的值修改为实际的配置服务器地址
--    例如：http://your-domain.com:8001
--    注意：必须是设备可以访问的外部地址（域名或公网IP），不能使用localhost
--
-- 3. 刷新config-service缓存
--    在管理后台点击"刷新config-service缓存"按钮使配置生效
--
-- 4. 测试配置
--    注册一个新设备，检查注册成功对话框是否正确显示配置服务器地址
--
-- ==========================================================================================================
-- 脚本结束
-- ==========================================================================================================
