# å®‰å…¨è§„èŒƒ

> æœ¬æ–‡æ¡£å®šä¹‰äº† CodeHubot é¡¹ç›®çš„å®‰å…¨å¼€å‘è§„èŒƒï¼ŒåŒ…æ‹¬è®¤è¯æˆæƒã€æ•°æ®åŠ å¯†å’Œå¸¸è§å®‰å…¨é˜²æŠ¤æªæ–½ã€‚

## ğŸ“‹ ç›®å½•

- [è®¤è¯æˆæƒ](#è®¤è¯æˆæƒ)
- [æ•°æ®åŠ å¯†](#æ•°æ®åŠ å¯†)
- [è¾“å…¥éªŒè¯](#è¾“å…¥éªŒè¯)
- [SQL æ³¨å…¥é˜²æŠ¤](#sql-æ³¨å…¥é˜²æŠ¤)
- [XSS é˜²æŠ¤](#xss-é˜²æŠ¤)
- [CSRF é˜²æŠ¤](#csrf-é˜²æŠ¤)
- [API å®‰å…¨](#api-å®‰å…¨)
- [æ•æ„Ÿä¿¡æ¯ä¿æŠ¤](#æ•æ„Ÿä¿¡æ¯ä¿æŠ¤)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

---

## ğŸ” è®¤è¯æˆæƒ

### 1. JWT Token è®¤è¯

```python
# backend/app/core/security.py
from datetime import datetime, timedelta
from jose import JWTError, jwt
from passlib.context import CryptContext

# å¯†ç åŠ å¯†ä¸Šä¸‹æ–‡
pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")

# JWT é…ç½®
SECRET_KEY = "your-secret-key"  # ä»ç¯å¢ƒå˜é‡è¯»å–
ALGORITHM = "HS256"
ACCESS_TOKEN_EXPIRE_MINUTES = 60 * 24  # 24å°æ—¶

def create_access_token(data: dict) -> str:
    """åˆ›å»ºè®¿é—®ä»¤ç‰Œ"""
    to_encode = data.copy()
    expire = datetime.utcnow() + timedelta(minutes=ACCESS_TOKEN_EXPIRE_MINUTES)
    to_encode.update({"exp": expire})
    
    encoded_jwt = jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)
    return encoded_jwt

def verify_token(token: str) -> dict:
    """éªŒè¯ä»¤ç‰Œ"""
    try:
        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])
        return payload
    except JWTError:
        return None

def verify_password(plain_password: str, hashed_password: str) -> bool:
    """éªŒè¯å¯†ç """
    return pwd_context.verify(plain_password, hashed_password)

def get_password_hash(password: str) -> str:
    """å¯†ç åŠ å¯†"""
    return pwd_context.hash(password)
```

### 2. ä¾èµ–æ³¨å…¥è·å–å½“å‰ç”¨æˆ·

```python
# backend/app/core/deps.py
from fastapi import Depends, HTTPException, status
from fastapi.security import HTTPBearer, HTTPAuthorizationCredentials
from sqlalchemy.orm import Session

from .database import get_db
from .security import verify_token
from ..models.user import User

security = HTTPBearer()

def get_current_user(
    credentials: HTTPAuthorizationCredentials = Depends(security),
    db: Session = Depends(get_db)
) -> User:
    """è·å–å½“å‰ç™»å½•ç”¨æˆ·"""
    
    # éªŒè¯ token
    token = credentials.credentials
    payload = verify_token(token)
    
    if not payload:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="tokenæ— æ•ˆæˆ–å·²è¿‡æœŸ",
            headers={"WWW-Authenticate": "Bearer"}
        )
    
    # è·å–ç”¨æˆ·ä¿¡æ¯
    user_id = payload.get("sub")
    user = db.query(User).filter(User.id == user_id).first()
    
    if not user:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="ç”¨æˆ·ä¸å­˜åœ¨"
        )
    
    if not user.is_active:
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail="è´¦å·å·²è¢«ç¦ç”¨"
        )
    
    return user

def get_current_admin(
    current_user: User = Depends(get_current_user)
):
    """è·å–å½“å‰ç®¡ç†å‘˜(æƒé™æ£€æŸ¥)"""
    if current_user.role not in ['admin', 'super_admin']:
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail="éœ€è¦ç®¡ç†å‘˜æƒé™"
        )
    return current_user
```

### 3. å‰ç«¯ Token ç®¡ç†

#### âš ï¸ **å®‰å…¨åŸåˆ™ï¼šæœ€å°åŒ–æ•æ„Ÿä¿¡æ¯å­˜å‚¨**

```javascript
// frontend/src/shared/utils/auth.js
/**
 * ç»Ÿä¸€çš„è®¤è¯å·¥å…·
 * 
 * å®‰å…¨åŸåˆ™ï¼š
 * - åªå­˜å‚¨å¿…è¦çš„ token
 * - ä¸åœ¨ localStorage å­˜å‚¨ç”¨æˆ·æ•æ„Ÿä¿¡æ¯
 * - ç”¨æˆ·ä¿¡æ¯é€šè¿‡ API å®æ—¶è·å–å¹¶å­˜å‚¨åœ¨å†…å­˜ï¼ˆPinia storeï¼‰ä¸­
 */

/**
 * è·å–è®¿é—®ä»¤ç‰Œ
 */
export function getToken() {
  return localStorage.getItem('access_token')
}

/**
 * è®¾ç½®è®¿é—®ä»¤ç‰Œ
 */
export function setToken(token) {
  localStorage.setItem('access_token', token)
}

/**
 * ç§»é™¤è®¿é—®ä»¤ç‰Œ
 */
export function removeToken() {
  localStorage.removeItem('access_token')
}

/**
 * è·å–åˆ·æ–°ä»¤ç‰Œ
 */
export function getRefreshToken() {
  return localStorage.getItem('refresh_token')
}

/**
 * è®¾ç½®åˆ·æ–°ä»¤ç‰Œ
 */
export function setRefreshToken(token) {
  localStorage.setItem('refresh_token', token)
}

/**
 * æ¸…é™¤æ‰€æœ‰è®¤è¯ä¿¡æ¯
 */
export function clearAuth() {
  removeToken()
  localStorage.removeItem('refresh_token')
  // æ³¨æ„ï¼šç”¨æˆ·ä¿¡æ¯ä¸å†å­˜å‚¨åœ¨ localStorageï¼Œç”± Pinia store ç®¡ç†
}

/**
 * æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
 */
export function isAuthenticated() {
  return !!getToken()
}
```

#### ğŸ” **localStorage å­˜å‚¨è§„èŒƒ**

**âœ… å…è®¸å­˜å‚¨çš„å†…å®¹ï¼š**
```javascript
// åªå­˜å‚¨ Tokenï¼ˆå¿…éœ€ï¼‰
localStorage.setItem('access_token', 'eyJhbGc...')
localStorage.setItem('refresh_token', 'eyJhbGc...')
```

**âŒ ç¦æ­¢å­˜å‚¨çš„å†…å®¹ï¼š**
```javascript
// âŒ ä¸è¦å­˜å‚¨ç”¨æˆ·ä¿¡æ¯ï¼ˆä¸å®‰å…¨ï¼‰
localStorage.setItem('userInfo', JSON.stringify({
  id: 123,
  username: "å¼ ä¸‰",
  email: "zhangsan@example.com",  // æ•æ„Ÿä¿¡æ¯
  phone: "13800138000",            // æ•æ„Ÿä¿¡æ¯
  role: "admin"
}))

// âŒ ä¸è¦å­˜å‚¨å…¶ä»–æ•æ„Ÿä¿¡æ¯
localStorage.setItem('api_key', 'xxx')
localStorage.setItem('password', 'xxx')
```

**æ­£ç¡®åšæ³•ï¼šç”¨æˆ·ä¿¡æ¯å­˜å‚¨åœ¨å†…å­˜ï¼ˆPinia Storeï¼‰**
```javascript
// frontend/src/stores/auth.js
import { defineStore } from 'pinia'

export const useAuthStore = defineStore('auth', () => {
  // âœ… ç”¨æˆ·ä¿¡æ¯åªå­˜å‚¨åœ¨å†…å­˜ä¸­
  const userInfo = ref(null)
  
  function setAuth(authData) {
    // åªä¿å­˜ token åˆ° localStorage
    setToken(authData.access_token)
    setRefreshToken(authData.refresh_token)
    
    // ç”¨æˆ·ä¿¡æ¯åªä¿å­˜åœ¨å†…å­˜ï¼ˆå…³é—­æµè§ˆå™¨åè‡ªåŠ¨æ¸…é™¤ï¼‰
    userInfo.value = authData.user
  }
  
  // é¡µé¢åˆ·æ–°åä»åç«¯é‡æ–°è·å–ç”¨æˆ·ä¿¡æ¯
  async function init() {
    const token = getToken()
    if (token) {
      try {
        const response = await fetchUserInfo()  // è°ƒç”¨ API
        userInfo.value = response.user
      } catch (error) {
        logout()
      }
    }
  }
  
  return { userInfo, setAuth, init }
})
```

### 4. è¯·æ±‚æ‹¦æˆªå™¨ - Token ç®¡ç†ä¸è‡ªåŠ¨åˆ·æ–°

#### åŸºç¡€é…ç½®

```javascript
// frontend/src/utils/request.js
import axios from 'axios'
import { ElMessage } from 'element-plus'
import router from '@/router'

const request = axios.create({
  baseURL: '/api',
  timeout: 30000
})
```

#### Token è‡ªåŠ¨åˆ·æ–°æœºåˆ¶

```javascript
// æ˜¯å¦æ­£åœ¨åˆ·æ–° token
let isRefreshing = false

// å¤±è´¥çš„è¯·æ±‚é˜Ÿåˆ—
let failedRequestsQueue = []

/**
 * åˆ·æ–° access token
 * @returns {Promise<string>} æ–°çš„ access token
 */
async function refreshToken() {
  const refreshToken = localStorage.getItem('refresh_token')
  
  if (!refreshToken) {
    throw new Error('No refresh token available')
  }

  try {
    // ä½¿ç”¨åŸå§‹ axios å‘é€åˆ·æ–°è¯·æ±‚ï¼Œé¿å…è§¦å‘æ‹¦æˆªå™¨
    const response = await axios.post('/api/auth/refresh', {
      refresh_token: refreshToken
    })

    const { access_token, refresh_token: newRefreshToken } = response.data.data

    // æ›´æ–° token
    localStorage.setItem('access_token', access_token)
    if (newRefreshToken) {
      localStorage.setItem('refresh_token', newRefreshToken)
    }

    console.log('âœ… Token åˆ·æ–°æˆåŠŸ')
    return access_token
  } catch (error) {
    console.error('âŒ Token åˆ·æ–°å¤±è´¥:', error)
    throw error
  }
}

/**
 * å¤„ç†å¤±è´¥çš„è¯·æ±‚é˜Ÿåˆ—
 */
function processFailedRequestsQueue(error = null) {
  failedRequestsQueue.forEach(callback => {
    callback(error)
  })
  failedRequestsQueue = []
}
```

#### è¯·æ±‚æ‹¦æˆªå™¨

```javascript
// è¯·æ±‚æ‹¦æˆªå™¨ - è‡ªåŠ¨æ·»åŠ  Token
request.interceptors.request.use(
  config => {
    const token = localStorage.getItem('access_token')
    
    if (token) {
      config.headers.Authorization = `Bearer ${token}`
    }
    
    return config
  },
  error => {
    console.error('è¯·æ±‚é”™è¯¯:', error)
    return Promise.reject(error)
  }
)
```

#### å“åº”æ‹¦æˆªå™¨ - è‡ªåŠ¨åˆ·æ–° Token

```javascript
// å“åº”æ‹¦æˆªå™¨ - å¤„ç† 401 é”™è¯¯å¹¶è‡ªåŠ¨åˆ·æ–° Token
request.interceptors.response.use(
  response => response.data,
  async error => {
    const originalRequest = error.config
    
    // å¤„ç† 401 é”™è¯¯ï¼šå°è¯•åˆ·æ–° token
    if (error.response?.status === 401 && !originalRequest._retry) {
      
      // å¦‚æœæ­£åœ¨åˆ·æ–° tokenï¼Œå°†è¯·æ±‚åŠ å…¥é˜Ÿåˆ—
      if (isRefreshing) {
        return new Promise((resolve, reject) => {
          failedRequestsQueue.push((error) => {
            if (error) {
              reject(error)
            } else {
              // ä½¿ç”¨æ–°çš„ token é‡è¯•è¯·æ±‚
              const token = localStorage.getItem('access_token')
              if (token) {
                originalRequest.headers.Authorization = `Bearer ${token}`
              }
              resolve(request(originalRequest))
            }
          })
        })
      }

      // æ ‡è®°æ­£åœ¨é‡è¯•
      originalRequest._retry = true
      isRefreshing = true

      try {
        // å°è¯•åˆ·æ–° token
        const newAccessToken = await refreshToken()
        
        // æ›´æ–°åŸå§‹è¯·æ±‚çš„ token
        originalRequest.headers.Authorization = `Bearer ${newAccessToken}`
        
        // å¤„ç†é˜Ÿåˆ—ä¸­çš„è¯·æ±‚
        processFailedRequestsQueue(null)
        
        // é‡è¯•åŸå§‹è¯·æ±‚
        return request(originalRequest)
        
      } catch (refreshError) {
        // token åˆ·æ–°å¤±è´¥ï¼Œæ¸…é™¤æ‰€æœ‰ token å¹¶è·³è½¬ç™»å½•é¡µ
        console.error('Token åˆ·æ–°å¤±è´¥ï¼Œéœ€è¦é‡æ–°ç™»å½•')
        
        // å¤„ç†é˜Ÿåˆ—ä¸­çš„è¯·æ±‚ï¼ˆéƒ½å¤±è´¥ï¼‰
        processFailedRequestsQueue(refreshError)
        
        // æ¸…é™¤æ‰€æœ‰ token
        localStorage.removeItem('access_token')
        localStorage.removeItem('refresh_token')
        
        // è·³è½¬åˆ°ç»Ÿä¸€ç™»å½•é¡µ
        router.push('/login')
        
        ElMessage.error('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•')
        
        return Promise.reject(refreshError)
      } finally {
        isRefreshing = false
      }
    }
    
    // å…¶ä»–é”™è¯¯å¤„ç†
    if (error.response) {
      const status = error.response.status
      const data = error.response.data
      
      switch (status) {
        case 400:
          ElMessage.error(data.message || data.detail || 'è¯·æ±‚å‚æ•°é”™è¯¯')
          break
        case 403:
          ElMessage.error('æ²¡æœ‰æƒé™è®¿é—®è¯¥èµ„æº')
          break
        case 404:
          ElMessage.error(data.message || data.detail || 'è¯·æ±‚çš„èµ„æºä¸å­˜åœ¨')
          break
        case 500:
          ElMessage.error('æœåŠ¡å™¨å†…éƒ¨é”™è¯¯')
          break
      }
    } else if (error.request) {
      ElMessage.error('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ')
    }
    
    return Promise.reject(error)
  }
)

export default request
```

#### å·¥ä½œæµç¨‹

```
ç”¨æˆ·è¯·æ±‚ API
  â†“
è¯·æ±‚æ‹¦æˆªå™¨æ·»åŠ  Authorization å¤´
  â†“
å‘é€è¯·æ±‚
  â†“
æ”¶åˆ° 401 å“åº”
  â†“
æ£€æŸ¥æ˜¯å¦æ­£åœ¨åˆ·æ–° Token
  â†“
â”œâ”€ æ˜¯ â†’ å°†è¯·æ±‚åŠ å…¥é˜Ÿåˆ—ï¼Œç­‰å¾…åˆ·æ–°å®Œæˆåé‡è¯•
â””â”€ å¦ â†’ è°ƒç”¨åˆ·æ–°ç«¯ç‚¹ (/api/auth/refresh)
    â†“
    â”œâ”€ åˆ·æ–°æˆåŠŸ
    â”‚   â†“
    â”‚   æ›´æ–° localStorage ä¸­çš„ token
    â”‚   â†“
    â”‚   é‡è¯•åŸå§‹è¯·æ±‚ï¼ˆä½¿ç”¨æ–° tokenï¼‰
    â”‚   â†“
    â”‚   å¤„ç†é˜Ÿåˆ—ä¸­çš„è¯·æ±‚
    â”‚
    â””â”€ åˆ·æ–°å¤±è´¥
        â†“
        æ¸…é™¤æ‰€æœ‰ token
        â†“
        è·³è½¬åˆ°ç™»å½•é¡µ
        â†“
        å¤„ç†é˜Ÿåˆ—ä¸­çš„è¯·æ±‚ï¼ˆéƒ½å¤±è´¥ï¼‰
```

#### å®‰å…¨ä¼˜åŠ¿

1. **æ— æ„Ÿåˆ·æ–°** - ç”¨æˆ·æ— éœ€æ‰‹åŠ¨é‡æ–°ç™»å½•
2. **å¹¶å‘å®‰å…¨** - é¿å…å¤šä¸ªè¯·æ±‚åŒæ—¶åˆ·æ–° token
3. **é˜Ÿåˆ—æœºåˆ¶** - åˆ·æ–°æœŸé—´çš„è¯·æ±‚ä¼šè‡ªåŠ¨æ’é˜Ÿå¹¶åœ¨åˆ·æ–°åé‡è¯•
4. **ä¼˜é›…é™çº§** - åˆ·æ–°å¤±è´¥æ—¶æ‰æ¸…é™¤ token å¹¶è·³è½¬ç™»å½•

---

## ğŸ”’ æ•°æ®åŠ å¯†

### 1. å¯†ç åŠ å¯†å­˜å‚¨

```python
# ç”¨æˆ·æ³¨å†Œæ—¶åŠ å¯†å¯†ç 
from app.core.security import get_password_hash

@router.post("/register")
def register(user_data: UserCreate, db: Session = Depends(get_db)):
    # âœ… åŠ å¯†å¯†ç 
    hashed_password = get_password_hash(user_data.password)
    
    user = User(
        username=user_data.username,
        email=user_data.email,
        password_hash=hashed_password  # å­˜å‚¨åŠ å¯†åçš„å¯†ç 
    )
    
    db.add(user)
    db.commit()
    
    return success_response(message="æ³¨å†ŒæˆåŠŸ")

# âŒ ç¦æ­¢: æ˜æ–‡å­˜å‚¨å¯†ç 
user = User(
    username=username,
    password=password  # å±é™©!
)
```

### 2. æ•æ„Ÿæ•°æ®åŠ å¯†

```python
from cryptography.fernet import Fernet

# ç”Ÿæˆå¯†é’¥(ä¿å­˜åˆ°ç¯å¢ƒå˜é‡)
# key = Fernet.generate_key()

class EncryptionService:
    """åŠ å¯†æœåŠ¡"""
    
    def __init__(self):
        # ä»ç¯å¢ƒå˜é‡è¯»å–å¯†é’¥
        key = os.getenv("ENCRYPTION_KEY")
        self.cipher = Fernet(key.encode())
    
    def encrypt(self, data: str) -> str:
        """åŠ å¯†æ•°æ®"""
        encrypted_data = self.cipher.encrypt(data.encode())
        return encrypted_data.decode()
    
    def decrypt(self, encrypted_data: str) -> str:
        """è§£å¯†æ•°æ®"""
        decrypted_data = self.cipher.decrypt(encrypted_data.encode())
        return decrypted_data.decode()

# ä½¿ç”¨ç¤ºä¾‹
encryption_service = EncryptionService()

# åŠ å¯† API å¯†é’¥
api_key = "sensitive-api-key"
encrypted_key = encryption_service.encrypt(api_key)

# å­˜å‚¨åˆ°æ•°æ®åº“
config = SystemConfig(
    config_key="api_key",
    config_value=encrypted_key  # å­˜å‚¨åŠ å¯†åçš„å€¼
)

# ä½¿ç”¨æ—¶è§£å¯†
decrypted_key = encryption_service.decrypt(config.config_value)
```

---

## âœ… è¾“å…¥éªŒè¯

### 1. åç«¯ Pydantic éªŒè¯

```python
from pydantic import BaseModel, Field, validator, EmailStr
import re

class UserCreate(BaseModel):
    """ç”¨æˆ·åˆ›å»ºéªŒè¯"""
    
    username: str = Field(..., min_length=3, max_length=20)
    email: EmailStr
    password: str = Field(..., min_length=8, max_length=50)
    
    @validator('username')
    def validate_username(cls, v):
        """ç”¨æˆ·åéªŒè¯"""
        # åªå…è®¸å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿
        if not re.match(r'^[a-zA-Z0-9_]+$', v):
            raise ValueError('ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿')
        return v
    
    @validator('password')
    def validate_password(cls, v):
        """å¯†ç å¼ºåº¦éªŒè¯"""
        # è‡³å°‘åŒ…å«ä¸€ä¸ªå¤§å†™å­—æ¯ã€ä¸€ä¸ªå°å†™å­—æ¯å’Œä¸€ä¸ªæ•°å­—
        if not re.search(r'[A-Z]', v):
            raise ValueError('å¯†ç å¿…é¡»åŒ…å«è‡³å°‘ä¸€ä¸ªå¤§å†™å­—æ¯')
        if not re.search(r'[a-z]', v):
            raise ValueError('å¯†ç å¿…é¡»åŒ…å«è‡³å°‘ä¸€ä¸ªå°å†™å­—æ¯')
        if not re.search(r'\d', v):
            raise ValueError('å¯†ç å¿…é¡»åŒ…å«è‡³å°‘ä¸€ä¸ªæ•°å­—')
        return v

class CourseCreate(BaseModel):
    """è¯¾ç¨‹åˆ›å»ºéªŒè¯"""
    
    title: str = Field(..., min_length=2, max_length=200)
    description: str = Field(None, max_length=2000)
    
    @validator('title')
    def validate_title(cls, v):
        """æ ‡é¢˜éªŒè¯"""
        # ç§»é™¤é¦–å°¾ç©ºç™½
        v = v.strip()
        if not v:
            raise ValueError('æ ‡é¢˜ä¸èƒ½ä¸ºç©º')
        # ç¦æ­¢ç‰¹æ®Šå­—ç¬¦
        if re.search(r'[<>\"\'&]', v):
            raise ValueError('æ ‡é¢˜åŒ…å«éæ³•å­—ç¬¦')
        return v
```

### 2. å‰ç«¯è¡¨å•éªŒè¯

```vue
<template>
  <el-form
    ref="formRef"
    :model="formData"
    :rules="formRules"
  >
    <el-form-item label="ç”¨æˆ·å" prop="username">
      <el-input v-model="formData.username" />
    </el-form-item>
    
    <el-form-item label="å¯†ç " prop="password">
      <el-input v-model="formData.password" type="password" />
    </el-form-item>
  </el-form>
</template>

<script setup>
import { ref, reactive } from 'vue'

const formRef = ref(null)

const formData = reactive({
  username: '',
  password: ''
})

// éªŒè¯è§„åˆ™
const formRules = {
  username: [
    { required: true, message: 'è¯·è¾“å…¥ç”¨æˆ·å', trigger: 'blur' },
    { min: 3, max: 20, message: 'é•¿åº¦åœ¨ 3 åˆ° 20 ä¸ªå­—ç¬¦', trigger: 'blur' },
    { 
      pattern: /^[a-zA-Z0-9_]+$/,
      message: 'åªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿',
      trigger: 'blur'
    }
  ],
  password: [
    { required: true, message: 'è¯·è¾“å…¥å¯†ç ', trigger: 'blur' },
    { min: 8, message: 'å¯†ç è‡³å°‘ 8 ä¸ªå­—ç¬¦', trigger: 'blur' },
    {
      validator: (rule, value, callback) => {
        if (!/[A-Z]/.test(value)) {
          callback(new Error('å¯†ç å¿…é¡»åŒ…å«è‡³å°‘ä¸€ä¸ªå¤§å†™å­—æ¯'))
        } else if (!/[a-z]/.test(value)) {
          callback(new Error('å¯†ç å¿…é¡»åŒ…å«è‡³å°‘ä¸€ä¸ªå°å†™å­—æ¯'))
        } else if (!/\d/.test(value)) {
          callback(new Error('å¯†ç å¿…é¡»åŒ…å«è‡³å°‘ä¸€ä¸ªæ•°å­—'))
        } else {
          callback()
        }
      },
      trigger: 'blur'
    }
  ]
}

async function handleSubmit() {
  // éªŒè¯è¡¨å•
  await formRef.value.validate()
  // æäº¤æ•°æ®...
}
</script>
```

---

## ğŸ›¡ï¸ SQL æ³¨å…¥é˜²æŠ¤

### 1. ä½¿ç”¨ ORM(æ¨è)

```python
from sqlalchemy.orm import Session

# âœ… æ­£ç¡®: ä½¿ç”¨ ORM,è‡ªåŠ¨é˜²æ­¢ SQL æ³¨å…¥
@router.get("/courses")
def get_courses(
    search: str = None,
    db: Session = Depends(get_db)
):
    query = db.query(Course)
    
    if search:
        # ORM ä¼šè‡ªåŠ¨è½¬ä¹‰å‚æ•°
        query = query.filter(Course.title.ilike(f"%{search}%"))
    
    courses = query.all()
    return success_response(data=[c.to_dict() for c in courses])

# âŒ å±é™©: æ‹¼æ¥ SQL å­—ç¬¦ä¸²
def get_courses_unsafe(search: str):
    # å±é™©! å­˜åœ¨ SQL æ³¨å…¥é£é™©
    sql = f"SELECT * FROM courses WHERE title LIKE '%{search}%'"
    result = db.execute(sql)
```

### 2. ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢

```python
from sqlalchemy import text

# âœ… æ­£ç¡®: ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
def get_user_by_username(username: str, db: Session):
    sql = text("SELECT * FROM users WHERE username = :username")
    result = db.execute(sql, {"username": username})
    return result.first()

# âŒ å±é™©: å­—ç¬¦ä¸²æ‹¼æ¥
def get_user_unsafe(username: str, db: Session):
    sql = f"SELECT * FROM users WHERE username = '{username}'"
    result = db.execute(sql)  # SQLæ³¨å…¥é£é™©!
```

---

## ğŸš« XSS é˜²æŠ¤

### 1. è¾“å‡ºè½¬ä¹‰

```vue
<template>
  <div>
    <!-- âœ… Vue è‡ªåŠ¨è½¬ä¹‰ -->
    <p>{{ userInput }}</p>
    
    <!-- âŒ å±é™©: v-html ä¸è½¬ä¹‰ -->
    <div v-html="userInput"></div>  <!-- XSSé£é™©! -->
    
    <!-- âœ… å¦‚æœå¿…é¡»ä½¿ç”¨ v-html,å…ˆæ¸…ç† -->
    <div v-html="sanitizedInput"></div>
  </div>
</template>

<script setup>
import { computed } from 'vue'
import DOMPurify from 'dompurify'

const userInput = ref('<script>alert("XSS")</script>')

// æ¸…ç† HTML
const sanitizedInput = computed(() => {
  return DOMPurify.sanitize(userInput.value)
})
</script>
```

### 2. åç«¯ HTML æ¸…ç†

```python
import bleach

def sanitize_html(html_content: str) -> str:
    """æ¸…ç† HTML,é˜²æ­¢ XSS"""
    
    # å…è®¸çš„æ ‡ç­¾
    allowed_tags = ['p', 'br', 'strong', 'em', 'u', 'a']
    
    # å…è®¸çš„å±æ€§
    allowed_attributes = {'a': ['href', 'title']}
    
    # æ¸…ç† HTML
    clean_html = bleach.clean(
        html_content,
        tags=allowed_tags,
        attributes=allowed_attributes,
        strip=True
    )
    
    return clean_html

# ä½¿ç”¨
@router.post("/articles")
def create_article(article: ArticleCreate, db: Session = Depends(get_db)):
    # æ¸…ç†ç”¨æˆ·è¾“å…¥çš„ HTML
    clean_content = sanitize_html(article.content)
    
    new_article = Article(
        title=article.title,
        content=clean_content  # å­˜å‚¨æ¸…ç†åçš„å†…å®¹
    )
    
    db.add(new_article)
    db.commit()
    
    return success_response(data=new_article.to_dict())
```

---

## ğŸ” CSRF é˜²æŠ¤

### 1. ä½¿ç”¨ CSRF Token

```python
# backend/app/main.py
from fastapi import FastAPI
from fastapi.middleware.csrf import CSRFMiddleware

app = FastAPI()

# æ·»åŠ  CSRF ä¸­é—´ä»¶
app.add_middleware(
    CSRFMiddleware,
    secret_key="your-secret-key"
)
```

### 2. SameSite Cookie

```python
from fastapi import Response

@router.post("/login")
def login(response: Response, user_data: LoginRequest):
    # åˆ›å»º token
    access_token = create_access_token(data={"sub": user.id})
    
    # è®¾ç½® Cookie,å¯ç”¨ SameSite
    response.set_cookie(
        key="access_token",
        value=access_token,
        httponly=True,  # é˜²æ­¢ JS è®¿é—®
        secure=True,    # ä»… HTTPS
        samesite="strict"  # é˜²æ­¢ CSRF
    )
    
    return success_response(message="ç™»å½•æˆåŠŸ")
```

---

## ğŸ”’ API å®‰å…¨

### 1. è¯·æ±‚é™æµ

```python
from slowapi import Limiter
from slowapi.util import get_remote_address

limiter = Limiter(key_func=get_remote_address)

@router.post("/login")
@limiter.limit("5/minute")  # æ¯åˆ†é’Ÿæœ€å¤š 5 æ¬¡è¯·æ±‚
def login(request: Request, user_data: LoginRequest):
    # ç™»å½•é€»è¾‘
    pass

@router.post("/api/courses")
@limiter.limit("100/hour")  # æ¯å°æ—¶æœ€å¤š 100 æ¬¡è¯·æ±‚
def create_course(request: Request, course: CourseCreate):
    # åˆ›å»ºè¯¾ç¨‹
    pass
```

### 2. CORS é…ç½®

```python
from fastapi.middleware.cors import CORSMiddleware

app.add_middleware(
    CORSMiddleware,
    allow_origins=[
        "https://yourdomain.com",  # ç”Ÿäº§ç¯å¢ƒåŸŸå
        "http://localhost:3000"     # å¼€å‘ç¯å¢ƒ
    ],
    allow_credentials=True,
    allow_methods=["GET", "POST", "PUT", "DELETE"],
    allow_headers=["*"],
)
```

---

## ğŸ” æ•æ„Ÿä¿¡æ¯ä¿æŠ¤

### 1. ç¯å¢ƒå˜é‡ç®¡ç†

```python
# backend/.env (ä¸è¦æäº¤åˆ° Git!)
DATABASE_URL=mysql://user:password@localhost/db
SECRET_KEY=your-secret-key
JWT_SECRET_KEY=your-jwt-secret
ENCRYPTION_KEY=your-encryption-key

# backend/.env.example (å¯ä»¥æäº¤)
DATABASE_URL=mysql://user:password@localhost/db
SECRET_KEY=change-me
JWT_SECRET_KEY=change-me
ENCRYPTION_KEY=change-me

# backend/app/core/config.py
import os
from dotenv import load_dotenv

load_dotenv()

class Settings:
    DATABASE_URL = os.getenv("DATABASE_URL")
    SECRET_KEY = os.getenv("SECRET_KEY")
    JWT_SECRET_KEY = os.getenv("JWT_SECRET_KEY")
    
    # éªŒè¯å¿…éœ€çš„ç¯å¢ƒå˜é‡
    def __init__(self):
        if not self.SECRET_KEY:
            raise ValueError("SECRET_KEY æœªè®¾ç½®")

settings = Settings()
```

### 2. .gitignore é…ç½®

```bash
# .gitignore

# ç¯å¢ƒå˜é‡æ–‡ä»¶
.env
.env.local
.env.*.local

# æ•æ„Ÿé…ç½®
config.py
secrets.yml

# æ—¥å¿—æ–‡ä»¶(å¯èƒ½åŒ…å«æ•æ„Ÿä¿¡æ¯)
*.log
logs/

# æ•°æ®åº“æ–‡ä»¶
*.db
*.sqlite

# å¯†é’¥æ–‡ä»¶
*.pem
*.key
*.crt
```

### 3. å“åº”ä¸­éšè—æ•æ„Ÿä¿¡æ¯

```python
class User(Base):
    """ç”¨æˆ·æ¨¡å‹"""
    __tablename__ = "users"
    
    id = Column(BigInteger, primary_key=True)
    username = Column(String(50))
    email = Column(String(100))
    password_hash = Column(String(255))  # å¯†ç å“ˆå¸Œ
    api_key = Column(String(100))        # API å¯†é’¥
    
    def to_dict(self, include_sensitive=False):
        """è½¬æ¢ä¸ºå­—å…¸"""
        data = {
            "id": self.id,
            "username": self.username,
            "email": self.email
            # âŒ ä¸è¦åŒ…å« password_hash, api_key
        }
        
        # ä»…åœ¨éœ€è¦æ—¶åŒ…å«æ•æ„Ÿä¿¡æ¯
        if include_sensitive:
            data["api_key"] = self.api_key
        
        return data

# API å“åº”
@router.get("/profile")
def get_profile(current_user = Depends(get_current_user)):
    # âœ… ä¸è¿”å›å¯†ç ç­‰æ•æ„Ÿä¿¡æ¯
    return success_response(data=current_user.to_dict())
```

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. å®‰å…¨æ£€æŸ¥æ¸…å•

```markdown
## å¼€å‘é˜¶æ®µ

- [ ] æ‰€æœ‰å¯†ç éƒ½å·²åŠ å¯†å­˜å‚¨
- [ ] ä½¿ç”¨ JWT æˆ– Session è¿›è¡Œè®¤è¯
- [ ] API æœ‰æƒé™æ§åˆ¶
- [ ] è¾“å…¥æ•°æ®å·²éªŒè¯
- [ ] ä½¿ç”¨ ORM é˜²æ­¢ SQL æ³¨å…¥
- [ ] è¾“å‡ºå·²è½¬ä¹‰é˜²æ­¢ XSS
- [ ] æ•æ„Ÿä¿¡æ¯æœªç¡¬ç¼–ç 
- [ ] .env æ–‡ä»¶æœªæäº¤åˆ° Git

## éƒ¨ç½²é˜¶æ®µ

- [ ] å¯ç”¨ HTTPS
- [ ] é…ç½® CORS ç™½åå•
- [ ] å¯ç”¨è¯·æ±‚é™æµ
- [ ] å…³é—­è°ƒè¯•æ¨¡å¼
- [ ] é…ç½®å®‰å…¨å“åº”å¤´
- [ ] å®šæœŸæ›´æ–°ä¾èµ–åŒ…
```

### 2. å®‰å…¨å“åº”å¤´

```python
from fastapi.middleware.trustedhost import TrustedHostMiddleware
from fastapi.middleware.httpsredirect import HTTPSRedirectMiddleware

# HTTPS é‡å®šå‘
app.add_middleware(HTTPSRedirectMiddleware)

# ä¿¡ä»»çš„ä¸»æœº
app.add_middleware(
    TrustedHostMiddleware,
    allowed_hosts=["yourdomain.com", "www.yourdomain.com"]
)

# è‡ªå®šä¹‰å“åº”å¤´
@app.middleware("http")
async def add_security_headers(request, call_next):
    response = await call_next(request)
    response.headers["X-Content-Type-Options"] = "nosniff"
    response.headers["X-Frame-Options"] = "DENY"
    response.headers["X-XSS-Protection"] = "1; mode=block"
    response.headers["Strict-Transport-Security"] = "max-age=31536000"
    return response
```

### 3. å®šæœŸå®‰å…¨å®¡è®¡

```bash
# Python ä¾èµ–å®‰å…¨æ£€æŸ¥
pip install safety
safety check

# JavaScript ä¾èµ–å®‰å…¨æ£€æŸ¥
npm audit

# ä»£ç å®‰å…¨æ‰«æ
pip install bandit
bandit -r backend/app/
```

---

## ğŸ“š å‚è€ƒèµ„æº

- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [FastAPI Security](https://fastapi.tiangolo.com/tutorial/security/)
- [Vue.js Security](https://vuejs.org/guide/best-practices/security.html)

---

**è®°ä½**: å®‰å…¨æ˜¯ç³»ç»Ÿçš„åŸºçŸ³ï¼Œæ°¸è¿œä¸è¦åœ¨å®‰å…¨ä¸Šå¦¥åï¼

---

## ğŸ” ç™»å½•éªŒè¯ç æœºåˆ¶ï¼ˆé˜²æš´åŠ›ç ´è§£ï¼‰

### åŠŸèƒ½æ¦‚è¿°

ä¸ºé˜²æ­¢å¯†ç æš´åŠ›ç ´è§£æ”»å‡»ï¼Œç³»ç»Ÿå®ç°äº†**å¤šå±‚å®‰å…¨é˜²æŠ¤æœºåˆ¶**ï¼š
- **ç¬¬1-2æ¬¡å¤±è´¥**ï¼šæ­£å¸¸ç™»å½•æµç¨‹
- **ç¬¬3-4æ¬¡å¤±è´¥**ï¼šå¼ºåˆ¶éªŒè¯ç 
- **ç¬¬5æ¬¡å¤±è´¥**ï¼šä¸´æ—¶ç¦ç”¨è´¦æˆ·30åˆ†é’Ÿ

### å®Œæ•´å®‰å…¨æµç¨‹

```
ç™»å½•æµç¨‹å›¾:

ç”¨æˆ·è¾“å…¥è´¦å·å¯†ç 
    â†“
æ£€æŸ¥æ˜¯å¦è¢«ç¦ç”¨ï¼Ÿ
    â”œâ”€ æ˜¯ â†’ æ‹’ç»ç™»å½•ï¼Œæ˜¾ç¤ºå‰©ä½™ç¦ç”¨æ—¶é—´
    â””â”€ å¦ â†’ ç»§ç»­
        â†“
    å¤±è´¥æ¬¡æ•° < 3ï¼Ÿ
        â”œâ”€ æ˜¯ â†’ ç›´æ¥éªŒè¯å¯†ç 
        â””â”€ å¦ â†’ éœ€è¦éªŒè¯ç 
            â†“
        å…ˆéªŒè¯éªŒè¯ç 
            â”œâ”€ é”™è¯¯ â†’ è®°å½•å¤±è´¥ +1 â†’ æ£€æŸ¥æ˜¯å¦â‰¥5æ¬¡ï¼Ÿ
            â”‚                       â”œâ”€ æ˜¯ â†’ ç¦ç”¨30åˆ†é’Ÿ
            â”‚                       â””â”€ å¦ â†’ æç¤ºé”™è¯¯
            â””â”€ æ­£ç¡® â†’ ç»§ç»­éªŒè¯å¯†ç 
                â†“
            éªŒè¯ç”¨æˆ·å¯†ç 
                â”œâ”€ é”™è¯¯ â†’ è®°å½•å¤±è´¥ +1 â†’ æ£€æŸ¥æ˜¯å¦â‰¥5æ¬¡ï¼Ÿ
                â”‚                       â”œâ”€ æ˜¯ â†’ ç¦ç”¨30åˆ†é’Ÿ
                â”‚                       â””â”€ å¦ â†’ æç¤ºé”™è¯¯
                â””â”€ æ­£ç¡® â†’ ç™»å½•æˆåŠŸ
                    â†“
                æ¸…é™¤å¤±è´¥è®°å½• + è§£é™¤ç¦ç”¨
```

### å…³é”®å®‰å…¨è®¾è®¡

#### 1. éªŒè¯é¡ºåºçš„é‡è¦æ€§

âš ï¸ **å…ˆéªŒè¯éªŒè¯ç ï¼Œå†éªŒè¯å¯†ç **

```python
# âœ… æ­£ç¡®ï¼šå…ˆéªŒè¯éªŒè¯ç ï¼ˆé˜²æ­¢ç»•è¿‡ï¼‰
if needs_captcha:
    if not verify_captcha(identifier, captcha_code):
        record_login_attempt(identifier)  # éªŒè¯ç é”™è¯¯ä¹Ÿè®¡å…¥
        raise HTTPException("éªŒè¯ç é”™è¯¯")

# éªŒè¯ç é€šè¿‡åï¼Œæ‰éªŒè¯å¯†ç 
if not verify_password(password, user.password_hash):
    record_login_attempt(identifier)
    raise HTTPException("å¯†ç é”™è¯¯")

# âŒ é”™è¯¯ï¼šå…ˆéªŒè¯å¯†ç ï¼Œå†éªŒè¯éªŒè¯ç 
# è¿™æ ·æ”»å‡»è€…å¯ä»¥æ— é™å°è¯•éªŒè¯ç è€Œä¸å¢åŠ å¤±è´¥æ¬¡æ•°
```

**ä¸ºä»€ä¹ˆè¦è¿™æ ·è®¾è®¡ï¼Ÿ**
- é˜²æ­¢æ”»å‡»è€…æ•…æ„è¾“å…¥é”™è¯¯éªŒè¯ç æ¥ç»•è¿‡å¯†ç éªŒè¯
- ç¡®ä¿éªŒè¯ç é”™è¯¯å’Œå¯†ç é”™è¯¯éƒ½è®¡å…¥å¤±è´¥æ¬¡æ•°
- é¿å…æ³„éœ²ç”¨æˆ·æ˜¯å¦å­˜åœ¨çš„ä¿¡æ¯

#### 2. ä¸‰å±‚å®‰å…¨é˜ˆå€¼

| å¤±è´¥æ¬¡æ•° | å®‰å…¨æªæ–½ | æç¤ºä¿¡æ¯ç¤ºä¾‹ |
|---------|---------|------------|
| **1-2æ¬¡** | æ­£å¸¸ç™»å½• | "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ï¼ˆè¿˜æœ‰1æ¬¡æœºä¼šéœ€è¦è¾“å…¥éªŒè¯ç ï¼‰" |
| **3-4æ¬¡** | å¼ºåˆ¶éªŒè¯ç  | "éªŒè¯ç é”™è¯¯ï¼ˆè¿˜æœ‰1æ¬¡æœºä¼šåå°†è¢«ç¦ç”¨30åˆ†é’Ÿï¼‰" |
| **5æ¬¡åŠä»¥ä¸Š** | ä¸´æ—¶ç¦ç”¨30åˆ†é’Ÿ | "è´¦æˆ·å·²è¢«ä¸´æ—¶ç¦ç”¨ã€‚è¯·åœ¨25åˆ†é’Ÿåé‡è¯•" |

#### 3. å¤±è´¥æ¬¡æ•°è®°å½•è§„åˆ™

```python
# ä»¥ä¸‹æƒ…å†µéƒ½ä¼šè®°å½•å¤±è´¥æ¬¡æ•°ï¼š
1. å¯†ç é”™è¯¯
2. éªŒè¯ç é”™è¯¯ï¼ˆè¾¾åˆ°éªŒè¯ç é˜ˆå€¼åï¼‰
3. ç”¨æˆ·åä¸å­˜åœ¨ï¼ˆä½†ä¸å‘Šè¯‰ç”¨æˆ·ï¼‰

# ä»¥ä¸‹æƒ…å†µä¼šæ¸…é™¤å¤±è´¥è®°å½•ï¼š
1. ç™»å½•æˆåŠŸ
2. 1å°æ—¶åè‡ªåŠ¨è¿‡æœŸ

# ä»¥ä¸‹æƒ…å†µä¼šè§£é™¤ç¦ç”¨ï¼š
1. ç™»å½•æˆåŠŸ
2. 30åˆ†é’Ÿåè‡ªåŠ¨è§£å°
```

### åç«¯å®ç°

#### 1. éªŒè¯ç å·¥å…·ç±»

**æ–‡ä»¶ä½ç½®**: `backend/app/utils/captcha.py`

```python
class CaptchaStore:
    """éªŒè¯ç å’Œç™»å½•å¤±è´¥æ¬¡æ•°ç®¡ç†ï¼ˆå†…å­˜å­˜å‚¨ï¼‰"""
    
    def __init__(self):
        self._store: Dict[str, dict] = {}              # éªŒè¯ç å­˜å‚¨
        self._login_attempts: Dict[str, dict] = {}     # å¤±è´¥æ¬¡æ•°è®°å½•
        self._blocked_accounts: Dict[str, datetime] = {} # è¢«ç¦ç”¨çš„è´¦æˆ·
    
    def is_account_blocked(self, identifier: str, block_duration_minutes: int = 30) -> bool:
        """æ£€æŸ¥è´¦æˆ·æ˜¯å¦è¢«ä¸´æ—¶ç¦ç”¨"""
        if identifier not in self._blocked_accounts:
            return False
        
        block_time = self._blocked_accounts[identifier]
        block_until = block_time + timedelta(minutes=block_duration_minutes)
        
        # æ£€æŸ¥æ˜¯å¦å·²ç»è§£å°
        if datetime.now() > block_until:
            del self._blocked_accounts[identifier]
            return False
        
        return True
    
    def block_account(self, identifier: str):
        """ä¸´æ—¶ç¦ç”¨è´¦æˆ·ï¼ˆå¤±è´¥5æ¬¡åè°ƒç”¨ï¼‰"""
        self._blocked_accounts[identifier] = datetime.now()
        logger.warning(f"è´¦æˆ·å·²è¢«ä¸´æ—¶ç¦ç”¨: identifier={identifier}")
    
    def get_block_remaining_time(self, identifier: str, block_duration_minutes: int = 30) -> Optional[int]:
        """è·å–è´¦æˆ·å‰©ä½™ç¦ç”¨æ—¶é—´ï¼ˆç§’ï¼‰"""
        if identifier not in self._blocked_accounts:
            return None
        
        block_time = self._blocked_accounts[identifier]
        block_until = block_time + timedelta(minutes=block_duration_minutes)
        remaining = (block_until - datetime.now()).total_seconds()
        
        return int(remaining) if remaining > 0 else None
```

#### 2. ç™»å½•æ¥å£ï¼ˆä¼˜åŒ–åçš„éªŒè¯é¡ºåºï¼‰

**æ–‡ä»¶ä½ç½®**: `backend/app/api/auth.py`

```python
# å®‰å…¨é˜ˆå€¼å¸¸é‡
LOGIN_ATTEMPT_THRESHOLD = 3  # éªŒè¯ç é˜ˆå€¼
BLOCK_THRESHOLD = 5          # ç¦ç”¨é˜ˆå€¼
BLOCK_DURATION_MINUTES = 30  # ç¦ç”¨æ—¶é•¿

@router.post("/login")
async def login(login_data: UserLogin, db: Session = Depends(get_db)):
    """ç”¨æˆ·ç™»å½• - å¤šå±‚å®‰å…¨é˜²æŠ¤"""
    
    login_identifier = login_data.email
    
    # æ­¥éª¤0: æ£€æŸ¥æ˜¯å¦è¢«ç¦ç”¨
    if captcha_store.is_account_blocked(login_identifier, BLOCK_DURATION_MINUTES):
        remaining = captcha_store.get_block_remaining_time(login_identifier, BLOCK_DURATION_MINUTES)
        raise HTTPException(
            status_code=403,
            detail=f"è´¦æˆ·å·²è¢«ä¸´æ—¶ç¦ç”¨ã€‚è¯·åœ¨ {remaining // 60} åˆ†é’Ÿåé‡è¯•"
        )
    
    # æ­¥éª¤1: å¦‚æœéœ€è¦éªŒè¯ç ï¼Œå…ˆéªŒè¯éªŒè¯ç ï¼ˆé‡è¦ï¼ï¼‰
    login_attempts = captcha_store.get_login_attempts(login_identifier)
    if login_attempts >= LOGIN_ATTEMPT_THRESHOLD:
        if not login_data.captcha_code:
            raise HTTPException(status_code=400, detail="è¯·è¾“å…¥éªŒè¯ç ")
        
        # éªŒè¯éªŒè¯ç ï¼ˆé”™è¯¯ä¹Ÿè®°å½•å¤±è´¥æ¬¡æ•°ï¼‰
        if not captcha_store.verify_captcha(login_identifier, login_data.captcha_code):
            captcha_store.record_login_attempt(login_identifier)
            current_attempts = captcha_store.get_login_attempts(login_identifier)
            
            # æ£€æŸ¥æ˜¯å¦è¾¾åˆ°ç¦ç”¨é˜ˆå€¼
            if current_attempts >= BLOCK_THRESHOLD:
                captcha_store.block_account(login_identifier)
                raise HTTPException(
                    status_code=403,
                    detail=f"ç”±äºå¤šæ¬¡ç™»å½•å¤±è´¥ï¼Œè´¦æˆ·å·²è¢«ä¸´æ—¶ç¦ç”¨ {BLOCK_DURATION_MINUTES} åˆ†é’Ÿ"
                )
            
            raise HTTPException(
                status_code=400,
                detail=f"éªŒè¯ç é”™è¯¯ï¼ˆè¿˜æœ‰{BLOCK_THRESHOLD - current_attempts}æ¬¡æœºä¼šåå°†è¢«ç¦ç”¨ï¼‰"
            )
    
    # æ­¥éª¤2: éªŒè¯ç é€šè¿‡åï¼Œå†éªŒè¯å¯†ç 
    user = db.query(User).filter(
        (User.email == login_identifier) | (User.username == login_identifier)
    ).first()
    
    if not user or not verify_password(login_data.password, user.password_hash):
        captcha_store.record_login_attempt(login_identifier)
        current_attempts = captcha_store.get_login_attempts(login_identifier)
        
        # æ£€æŸ¥æ˜¯å¦è¾¾åˆ°ç¦ç”¨é˜ˆå€¼
        if current_attempts >= BLOCK_THRESHOLD:
            captcha_store.block_account(login_identifier)
            raise HTTPException(
                status_code=403,
                detail=f"ç”±äºå¤šæ¬¡ç™»å½•å¤±è´¥ï¼Œè´¦æˆ·å·²è¢«ä¸´æ—¶ç¦ç”¨ {BLOCK_DURATION_MINUTES} åˆ†é’Ÿ"
            )
        
        # æ ¹æ®å¤±è´¥æ¬¡æ•°ç»™å‡ºä¸åŒæç¤º
        if current_attempts >= LOGIN_ATTEMPT_THRESHOLD:
            detail = f"å¯†ç é”™è¯¯ï¼ˆè¿˜æœ‰{BLOCK_THRESHOLD - current_attempts}æ¬¡æœºä¼šåå°†è¢«ç¦ç”¨ï¼‰"
        else:
            detail = f"å¯†ç é”™è¯¯ï¼ˆè¿˜æœ‰{LOGIN_ATTEMPT_THRESHOLD - current_attempts}æ¬¡æœºä¼šéœ€è¦è¾“å…¥éªŒè¯ç ï¼‰"
        
        raise HTTPException(status_code=401, detail=detail)
    
    # æ­¥éª¤3: ç™»å½•æˆåŠŸï¼Œæ¸…é™¤å¤±è´¥è®°å½•
    captcha_store.reset_login_attempts(login_identifier)
    captcha_store.unblock_account(login_identifier)
    
    # ç”ŸæˆTokenå¹¶è¿”å›...
```

### éªŒè¯ç ç‰¹æ€§

| ç‰¹æ€§ | è¯´æ˜ |
|-----|------|
| è§¦å‘æ¡ä»¶ | ç™»å½•å¤±è´¥ 3 æ¬¡ |
| éªŒè¯ç é•¿åº¦ | 4 ä½å­—ç¬¦ |
| å­—ç¬¦é›† | A-Z + 2-9ï¼ˆæ’é™¤ 0Oã€1Il ç­‰æ˜“æ··æ·†å­—ç¬¦ï¼‰ |
| æœ‰æ•ˆæœŸ | 5 åˆ†é’Ÿ |
| ä½¿ç”¨æ¬¡æ•° | ä¸€æ¬¡æ€§ï¼ˆéªŒè¯åç«‹å³å¤±æ•ˆï¼‰ |
| å¤§å°å†™ | ä¸åŒºåˆ† |
| éªŒè¯å¤±è´¥ | **è®¡å…¥å¤±è´¥æ¬¡æ•°**ï¼ˆé‡è¦ï¼ï¼‰ |
| å¤±è´¥è®°å½• | 1 å°æ—¶åè‡ªåŠ¨é‡ç½® |
| å›¾ç‰‡æ ¼å¼ | PNGï¼Œ120x40pxï¼Œ2-3KB |
| å¹²æ‰°å¤„ç† | å¹²æ‰°çº¿ + å™ªç‚¹ + æ¨¡ç³Š |

### ä¸´æ—¶ç¦ç”¨ç‰¹æ€§

| ç‰¹æ€§ | è¯´æ˜ |
|-----|------|
| è§¦å‘æ¡ä»¶ | ç™»å½•å¤±è´¥ 5 æ¬¡ï¼ˆåŒ…æ‹¬éªŒè¯ç é”™è¯¯ï¼‰ |
| ç¦ç”¨æ—¶é•¿ | 30 åˆ†é’Ÿ |
| è§£å°æ–¹å¼ | 30åˆ†é’Ÿåè‡ªåŠ¨è§£å° æˆ– ç™»å½•æˆåŠŸç«‹å³è§£å° |
| ç¦ç”¨æœŸé—´ | æ‹’ç»æ‰€æœ‰ç™»å½•å°è¯•ï¼Œæ˜¾ç¤ºå‰©ä½™æ—¶é—´ |
| å­˜å‚¨æ–¹å¼ | å†…å­˜å­˜å‚¨ï¼ˆå¯è¿ç§»åˆ°Redisï¼‰ |

### å®‰å…¨ä¼˜åŠ¿

1. âœ… **é˜²æš´åŠ›ç ´è§£** - é™åˆ¶è¿ç»­å°è¯•æ¬¡æ•°ï¼Œå¢åŠ ç ´è§£æˆæœ¬
2. âœ… **å…ˆéªŒè¯ç åå¯†ç ** - é˜²æ­¢ç»•è¿‡éªŒè¯ç æœºåˆ¶
3. âœ… **éªŒè¯ç é”™è¯¯è®¡æ•°** - é˜²æ­¢æ— é™å°è¯•éªŒè¯ç 
4. âœ… **è‡ªåŠ¨é‡ç½®** - 1å°æ—¶åæˆ–ç™»å½•æˆåŠŸè‡ªåŠ¨æ¸…é™¤è®°å½•
5. âœ… **ä¸´æ—¶ç¦ç”¨** - 5æ¬¡å¤±è´¥åç¦ç”¨30åˆ†é’Ÿ
6. âœ… **é˜² OCR è¯†åˆ«** - å«å¹²æ‰°çº¿ã€å™ªç‚¹å’Œæ¨¡ç³Šå¤„ç†
7. âœ… **ä¸æ³„éœ²ä¿¡æ¯** - ä¸æš´éœ²ç”¨æˆ·æ˜¯å¦å­˜åœ¨
8. âœ… **ç”¨æˆ·å‹å¥½** - åˆ†å±‚æç¤ºï¼Œæ˜¾ç¤ºå‰©ä½™æœºä¼šå’Œæ—¶é—´

### éƒ¨ç½²é…ç½®

#### 1. å®‰è£…ä¾èµ–

```bash
# å®‰è£… Pillow åº“ï¼ˆç”¨äºç”ŸæˆéªŒè¯ç å›¾ç‰‡ï¼‰
pip install Pillow>=10.0.0
```

#### 2. é…ç½®å‚æ•°

å¯åœ¨ `backend/app/api/auth.py` ä¸­ä¿®æ”¹é…ç½®ï¼š

```python
# éªŒè¯ç é˜ˆå€¼ï¼ˆé»˜è®¤3æ¬¡ï¼‰- å¤±è´¥3æ¬¡åéœ€è¦éªŒè¯ç 
LOGIN_ATTEMPT_THRESHOLD = 3

# ç¦ç”¨é˜ˆå€¼ï¼ˆé»˜è®¤5æ¬¡ï¼‰- å¤±è´¥5æ¬¡åä¸´æ—¶ç¦ç”¨
BLOCK_THRESHOLD = 5

# ç¦ç”¨æ—¶é•¿ï¼ˆé»˜è®¤30åˆ†é’Ÿï¼‰
BLOCK_DURATION_MINUTES = 30

# åœ¨ captcha.py ä¸­å¯ä¿®æ”¹ï¼š
# - éªŒè¯ç é•¿åº¦ï¼šgenerate_captcha_code(length=4)
# - éªŒè¯ç æœ‰æ•ˆæœŸï¼šset_captcha(expire_minutes=5)
# - å¤±è´¥è®°å½•ä¿ç•™æ—¶é—´ï¼štimedelta(hours=1)
```

### æ³¨æ„äº‹é¡¹

âš ï¸ **éªŒè¯é¡ºåºè‡³å…³é‡è¦**
```python
# é”™è¯¯çš„é¡ºåºå¯èƒ½è¢«åˆ©ç”¨ï¼š
1. å…ˆéªŒè¯å¯†ç ï¼Œæ”»å‡»è€…å¯ä»¥æµ‹è¯•å¯†ç è€Œä¸æ¶ˆè€—éªŒè¯ç 
2. éªŒè¯ç é”™è¯¯ä¸è®¡æ•°ï¼Œæ”»å‡»è€…å¯ä»¥æ— é™å°è¯•éªŒè¯ç 

# æ­£ç¡®çš„é¡ºåºï¼š
1. å…ˆæ£€æŸ¥ç¦ç”¨çŠ¶æ€
2. å†éªŒè¯éªŒè¯ç ï¼ˆé”™è¯¯ä¹Ÿè®¡æ•°ï¼‰
3. æœ€åéªŒè¯å¯†ç ï¼ˆé”™è¯¯ä¹Ÿè®¡æ•°ï¼‰
```

âš ï¸ **å†…å­˜å­˜å‚¨é™åˆ¶**
- å½“å‰ä½¿ç”¨å†…å­˜å­˜å‚¨ï¼ŒæœåŠ¡é‡å¯åæ•°æ®ä¸¢å¤±
- ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨ Redis å­˜å‚¨ï¼ˆç”¨äºåˆ†å¸ƒå¼éƒ¨ç½²ï¼‰

âš ï¸ **é…ç½®å»ºè®®**
- éªŒè¯ç é˜ˆå€¼å»ºè®®ï¼š3æ¬¡ï¼ˆå¹³è¡¡å®‰å…¨å’Œä½“éªŒï¼‰
- ç¦ç”¨é˜ˆå€¼å»ºè®®ï¼š5æ¬¡ï¼ˆä¸¥æ ¼ä¿æŠ¤ï¼‰
- ç¦ç”¨æ—¶é•¿å»ºè®®ï¼š30åˆ†é’Ÿï¼ˆè¶³å¤Ÿé•¿ä»¥é˜»æ­¢æš´åŠ›ç ´è§£ï¼‰

### ç›¸å…³æ–‡æ¡£

- [ç™»å½•ç™»å‡ºæœºåˆ¶](../../docs_æŠ€æœ¯æ–‡æ¡£/01_è®¤è¯æˆæƒ/ç™»å½•ç™»å‡ºæœºåˆ¶.md)
- [APIå¼€å‘è§„èŒƒ](./01_APIå¼€å‘è§„èŒƒ.md)
