# 数据库规范

> 本文档定义了 CodeHubot 项目的数据库设计和 SQL 编写规范，确保数据库结构清晰、可维护。

## 📋 目录

- [表命名规范](#表命名规范)
- [字段命名规范](#字段命名规范)
- [索引规范](#索引规范)
- [字段类型规范](#字段类型规范)
- [SQL 编写规范](#sql-编写规范)
- [MySQL 5.7-8.0 兼容性](#mysql-57-80-兼容性)
- [最佳实践](#最佳实践)

---

## 📊 表命名规范

### 1. 命名规则

```sql
-- 表命名规范:
-- - 所有表名统一使用前缀,便于区分不同业务模块的表
-- - 核心表使用 aiot_core_ 前缀,标识为最小系统必需的表
-- - 扩展表使用 aiot_ 前缀 + 模块标识,标识为可选功能表
-- - 使用下划线分隔单词,表名使用复数形式(如 courses, students, tasks)
-- - 相关表使用模块前缀,便于识别和管理

-- ✅ 核心表示例(aiot_core_*)
CREATE TABLE `aiot_core_users` (...);           -- 用户表
CREATE TABLE `aiot_core_devices` (...);         -- 设备表
CREATE TABLE `aiot_core_system_config` (...);   -- 系统配置表

-- ✅ 扩展表示例(aiot_*)
CREATE TABLE `aiot_workflows` (...);            -- 工作流表
CREATE TABLE `aiot_knowledge_bases` (...);      -- 知识库表
CREATE TABLE `aiot_agents` (...);               -- 智能体表

-- ❌ 错误命名
CREATE TABLE `Course` (...);          -- 错误:应该小写
CREATE TABLE `course` (...);          -- 错误:应该复数形式
CREATE TABLE `courses` (...);         -- 错误:缺少前缀
```

### 2. 核心表 vs 扩展表

```sql
-- 核心表(aiot_core_*): 系统运行必需的基础表,最小系统必须包含
-- - 用户管理
-- - 设备管理
-- - 系统配置
-- - 基础权限

-- 扩展表(aiot_*): 可选功能表,可根据业务需求选择性部署
-- - AI 功能(agents, workflows, knowledge_bases)
-- - 其他扩展模块
```

---

## 🏷️ 字段命名规范

### 1. 通用字段命名

```sql
-- ✅ 标准字段命名

-- 主键: id (BIGINT AUTO_INCREMENT)
`id` BIGINT(20) NOT NULL AUTO_INCREMENT PRIMARY KEY

-- UUID: uuid (VARCHAR(36), UNIQUE)
`uuid` VARCHAR(36) NOT NULL UNIQUE COMMENT '唯一标识符'

-- 外键: {关联表名单数}_id
`user_id` BIGINT(20) DEFAULT NULL COMMENT '用户ID'
`course_id` BIGINT(20) DEFAULT NULL COMMENT '课程ID'
`school_id` BIGINT(20) DEFAULT NULL COMMENT '学校ID'

-- 布尔字段: is_{name} (TINYINT(1))
`is_active` TINYINT(1) DEFAULT 1 COMMENT '是否激活'
`is_deleted` TINYINT(1) DEFAULT 0 COMMENT '是否删除'
`is_published` TINYINT(1) DEFAULT 0 COMMENT '是否发布'

-- 时间字段: {动作}_at (DATETIME)
`created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间'
`updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间'
`deleted_at` DATETIME DEFAULT NULL COMMENT '删除时间'
`published_at` DATETIME DEFAULT NULL COMMENT '发布时间'

-- 操作人字段: {动作}_by
`created_by` BIGINT(20) DEFAULT NULL COMMENT '创建人ID'
`updated_by` BIGINT(20) DEFAULT NULL COMMENT '更新人ID'

-- 数量/计数: {name}_count
`student_count` INT(11) DEFAULT 0 COMMENT '学生数量'
`view_count` INT(11) DEFAULT 0 COMMENT '浏览次数'

-- 名称字段
`name` VARCHAR(100) NOT NULL COMMENT '名称'
`title` VARCHAR(200) NOT NULL COMMENT '标题'
`description` TEXT DEFAULT NULL COMMENT '描述'
```

### 2. 字段命名规则

```sql
-- ✅ 推荐
user_id          -- 清晰明确
student_name     -- 描述性强
course_status    -- 语义清晰
created_at       -- 标准命名

-- ❌ 避免
uid              -- 太简短,不清晰
stuName          -- 驼峰命名不符合 SQL 规范
cStatus          -- 缩写不明确
ctime            -- 缩写不规范
```

---

## 🔍 索引规范

### 1. 索引命名规则

```sql
-- 主键索引: PRIMARY KEY (自动命名)
PRIMARY KEY (`id`)

-- 唯一索引: uk_{column_name} 或 uk_{col1}_{col2}
UNIQUE KEY `uk_uuid` (`uuid`)
UNIQUE KEY `uk_email` (`email`)
UNIQUE KEY `uk_course_student` (`course_id`, `student_id`)

-- 普通索引: idx_{column_name} 或 idx_{col1}_{col2}
KEY `idx_user_id` (`user_id`)
KEY `idx_status` (`status`)
KEY `idx_created_at` (`created_at`)
KEY `idx_school_status` (`school_id`, `status`)

-- 外键索引: fk_{table}_{column}
KEY `fk_courses_school` (`school_id`)
CONSTRAINT `fk_courses_school` FOREIGN KEY (`school_id`) 
  REFERENCES `aiot_core_schools` (`id`) ON DELETE CASCADE
```

### 2. 索引使用原则

```sql
-- ✅ 需要建立索引的情况:
-- 1. 主键字段(自动)
-- 2. 唯一约束字段(UUID, 邮箱等)
-- 3. 频繁作为 WHERE 条件的字段
-- 4. 频繁用于 JOIN 的字段(外键)
-- 5. 频繁排序的字段(ORDER BY)
-- 6. 频繁分组的字段(GROUP BY)

-- 示例
CREATE TABLE `aiot_workflows` (
  `id` BIGINT(20) NOT NULL AUTO_INCREMENT,
  `uuid` VARCHAR(36) NOT NULL,
  `user_id` BIGINT(20) NOT NULL,
  `status` VARCHAR(20) DEFAULT 'draft',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_uuid` (`uuid`),
  KEY `idx_user_id` (`user_id`),               -- 频繁按用户查询
  KEY `idx_status` (`status`),                  -- 频繁按状态筛选
  KEY `idx_created_at` (`created_at`),          -- 频繁按时间排序
  KEY `idx_user_status` (`user_id`, `status`)   -- 联合查询优化
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- ❌ 避免过度索引:
-- 1. 选择性低的字段(如性别、布尔值)
-- 2. 频繁更新的字段
-- 3. 表数据量很小(<1000行)
-- 4. 很少查询的字段
```

### 3. 联合索引顺序

```sql
-- 联合索引遵循"最左前缀"原则
-- 索引: idx_school_status_created (school_id, status, created_at)

-- ✅ 可以使用索引的查询:
WHERE school_id = 1
WHERE school_id = 1 AND status = 'active'
WHERE school_id = 1 AND status = 'active' AND created_at > '2024-01-01'

-- ❌ 不能使用索引:
WHERE status = 'active'                    -- 跳过了第一列
WHERE created_at > '2024-01-01'           -- 跳过了前两列

-- 索引字段顺序原则:
-- 1. 区分度高的字段放前面
-- 2. 频繁查询的字段放前面
-- 3. 排序字段放最后
```

---

## 📝 字段类型规范

### 1. 整数类型

```sql
-- TINYINT(1): 布尔值
`is_active` TINYINT(1) DEFAULT 1

-- TINYINT(4): 小整数(-128 到 127)
`status_code` TINYINT(4) DEFAULT 0

-- INT(11): 普通整数
`student_count` INT(11) DEFAULT 0
`view_count` INT(11) DEFAULT 0

-- BIGINT(20): 大整数(ID、外键)
`id` BIGINT(20) NOT NULL AUTO_INCREMENT
`user_id` BIGINT(20) DEFAULT NULL
```

### 2. 字符串类型

```sql
-- VARCHAR(n): 可变长度字符串(常用)
`name` VARCHAR(100) NOT NULL                    -- 名称(简短)
`title` VARCHAR(200) NOT NULL                   -- 标题
`email` VARCHAR(100) DEFAULT NULL               -- 邮箱
`phone` VARCHAR(20) DEFAULT NULL                -- 电话
`uuid` VARCHAR(36) NOT NULL                     -- UUID

-- TEXT: 长文本(描述、内容)
`description` TEXT DEFAULT NULL                 -- 描述
`content` TEXT DEFAULT NULL                     -- 内容
`remark` TEXT DEFAULT NULL                      -- 备注

-- LONGTEXT: 超长文本(文章、配置)
`article_content` LONGTEXT DEFAULT NULL         -- 文章内容
`json_config` LONGTEXT DEFAULT NULL             -- JSON 配置

-- CHAR(n): 固定长度(很少使用)
`country_code` CHAR(2) DEFAULT NULL             -- 国家代码(如 CN)

-- 字符串长度建议:
-- 名称: 50-100
-- 标题: 100-200
-- 邮箱/电话: 50-100
-- 简短描述: VARCHAR(500)
-- 长描述: TEXT
-- 超长内容: LONGTEXT
```

### 3. 数值类型

```sql
-- DECIMAL: 精确小数(金额、分数)
`price` DECIMAL(10,2) DEFAULT 0.00 COMMENT '价格'
`score` DECIMAL(5,2) DEFAULT 0.00 COMMENT '分数'

-- FLOAT/DOUBLE: 浮点数(科学计算,精度要求不高)
`latitude` DOUBLE DEFAULT NULL COMMENT '纬度'
`longitude` DOUBLE DEFAULT NULL COMMENT '经度'
```

### 4. 日期时间类型

```sql
-- DATETIME: 日期时间(推荐)
`created_at` DATETIME DEFAULT CURRENT_TIMESTAMP
`updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
`published_at` DATETIME DEFAULT NULL

-- TIMESTAMP: 时间戳(自动转换时区,较少使用)
`last_login_at` TIMESTAMP DEFAULT NULL

-- DATE: 仅日期
`birth_date` DATE DEFAULT NULL

-- TIME: 仅时间
`class_time` TIME DEFAULT NULL
```

### 5. JSON 类型

```sql
-- JSON: 结构化数据(MySQL 5.7+)
`extra_data` JSON DEFAULT NULL COMMENT '扩展数据'
`settings` JSON DEFAULT NULL COMMENT '设置'
`metadata` JSON DEFAULT NULL COMMENT '元数据'

-- 示例数据:
-- {"theme": "dark", "language": "zh-CN"}
```

---

## 📝 SQL 编写规范

### 1. 建表规范

```sql
-- ✅ 完整的建表语句模板
CREATE TABLE IF NOT EXISTS `aiot_workflows` (
  -- 主键
  `id` BIGINT(20) NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  
  -- UUID(必备)
  `uuid` VARCHAR(36) NOT NULL COMMENT '唯一标识符',
  
  -- 业务字段
  `user_id` BIGINT(20) NOT NULL COMMENT '用户ID',
  `name` VARCHAR(200) NOT NULL COMMENT '工作流名称',
  `description` TEXT DEFAULT NULL COMMENT '工作流描述',
  `status` VARCHAR(20) DEFAULT 'draft' COMMENT '状态: draft/published/archived',
  
  -- 统计字段
  `execution_count` INT(11) DEFAULT 0 COMMENT '执行次数',
  `view_count` INT(11) DEFAULT 0 COMMENT '浏览次数',
  
  -- 软删除
  `is_deleted` TINYINT(1) DEFAULT 0 COMMENT '是否删除: 0-否, 1-是',
  `deleted_at` DATETIME DEFAULT NULL COMMENT '删除时间',
  
  -- 时间戳(必备)
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  
  -- 创建人(可选)
  `created_by` BIGINT(20) DEFAULT NULL COMMENT '创建人ID',
  `updated_by` BIGINT(20) DEFAULT NULL COMMENT '更新人ID',
  
  -- 索引
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_uuid` (`uuid`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_status` (`status`),
  KEY `idx_created_at` (`created_at`)
  
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='工作流表';
```

### 2. 必备字段

```sql
-- 每个表必须包含的字段:
`id` BIGINT(20) NOT NULL AUTO_INCREMENT         -- 主键
`uuid` VARCHAR(36) NOT NULL                     -- UUID
`created_at` DATETIME DEFAULT CURRENT_TIMESTAMP -- 创建时间
`updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP -- 更新时间

-- 软删除表需要额外包含:
`is_deleted` TINYINT(1) DEFAULT 0               -- 是否删除
`deleted_at` DATETIME DEFAULT NULL              -- 删除时间
```

### 3. 注释规范

```sql
-- 表注释: 说明表的用途
COMMENT='工作流表'

-- 字段注释: 说明字段含义、取值范围
`status` VARCHAR(20) DEFAULT 'draft' COMMENT '状态: draft-草稿, published-已发布, archived-已归档'

-- 枚举值说明
`role` VARCHAR(20) COMMENT '角色: admin-管理员, individual-独立用户'

-- 外键说明
`user_id` BIGINT(20) NOT NULL COMMENT '用户ID(关联 aiot_core_users.id)'
```

---

## 🔧 MySQL 5.7-8.0 兼容性

### ⚠️ 重要: 禁止使用的 MySQL 8.0+ 特性

```sql
-- ❌ 禁止使用 (仅 MySQL 8.0.13+ 支持)

-- 1. ADD COLUMN IF NOT EXISTS
ALTER TABLE `aiot_workflows` 
ADD COLUMN IF NOT EXISTS `template_id` BIGINT(20);  -- ❌ 不兼容

-- 2. ADD KEY IF NOT EXISTS
ALTER TABLE `aiot_workflows` 
ADD KEY IF NOT EXISTS `idx_template_id` (`template_id`);  -- ❌ 不兼容

-- 3. DROP COLUMN IF EXISTS
ALTER TABLE `aiot_workflows` 
DROP COLUMN IF EXISTS `old_column`;  -- ❌ 不兼容
```

### ✅ 兼容性解决方案

#### 方案1: CREATE TABLE IF NOT EXISTS (推荐)

```sql
-- ✅ 可重复执行,如果表已存在则跳过
CREATE TABLE IF NOT EXISTS `aiot_workflows` (
  `id` BIGINT(20) NOT NULL AUTO_INCREMENT,
  `name` VARCHAR(200) NOT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

#### 方案2: INSERT IGNORE (推荐)

```sql
-- ✅ 可重复执行,如果数据已存在则跳过(基于唯一键)
INSERT IGNORE INTO `aiot_core_system_config` 
(`config_key`, `config_value`) 
VALUES ('enable_ai_module', 'true');
```

#### 方案3: 动态 SQL 检查列是否存在

```sql
-- ✅ 检查列是否存在,不存在才添加
SET @column_exists = (
  SELECT COUNT(*) FROM information_schema.COLUMNS 
  WHERE TABLE_SCHEMA = DATABASE() 
    AND TABLE_NAME = 'aiot_workflows' 
    AND COLUMN_NAME = 'template_id'
);

SET @sql = IF(@column_exists = 0,
  'ALTER TABLE `aiot_workflows` ADD COLUMN `template_id` BIGINT(20) DEFAULT NULL COMMENT \'模板ID\' AFTER `uuid`',
  'SELECT "Column already exists" AS notice'
);

PREPARE stmt FROM @sql;
EXECUTE stmt;
DEALLOCATE PREPARE stmt;
```

#### 方案4: 动态 SQL 检查索引

```sql
-- ✅ 检查索引是否存在,不存在才添加
SET @index_exists = (
  SELECT COUNT(*) FROM information_schema.STATISTICS 
  WHERE TABLE_SCHEMA = DATABASE() 
    AND TABLE_NAME = 'aiot_workflows' 
    AND INDEX_NAME = 'idx_template_id'
);

SET @sql = IF(@index_exists = 0,
  'ALTER TABLE `aiot_workflows` ADD KEY `idx_template_id` (`template_id`)',
  'SELECT "Index already exists" AS notice'
);

PREPARE stmt FROM @sql;
EXECUTE stmt;
DEALLOCATE PREPARE stmt;
```

#### 方案5: 直接执行(仅用于一次性脚本)

```sql
-- ⚠️ 注意: 此方案只能执行一次,重复执行会报错
-- 适用于首次部署或明确知道不会重复执行的场景

ALTER TABLE `aiot_workflows` 
ADD COLUMN `template_id` BIGINT(20) DEFAULT NULL COMMENT '模板ID' AFTER `uuid`;

-- 建议在脚本开头注释说明:
-- 本脚本仅可执行一次,不可重复执行
```

### 📝 脚本编写原则

```sql
-- ✅ 推荐: 可重复执行的脚本
/*
 * 文件: 30_add_course_template.sql
 * 说明: 添加课程模板功能
 * 兼容性: MySQL 5.7+
 * 可重复执行: 是
 */

-- 方案1: 使用 CREATE TABLE IF NOT EXISTS
CREATE TABLE IF NOT EXISTS `aiot_workflow_templates` (...);

-- 方案2: 使用动态 SQL 添加列
SET @column_exists = (...);
-- ... 动态 SQL 代码

-- ❌ 不推荐: 不可重复执行的脚本
/*
 * 警告: 本脚本仅可执行一次!
 */
ALTER TABLE `aiot_workflows` ADD COLUMN `template_id` BIGINT(20);
```

### 🚫 禁止使用存储过程

```sql
-- ❌ 禁止使用存储过程 (Stored Procedures)
-- 包括业务逻辑和 SQL 更新脚本中都不要使用

-- ❌ 错误示例
DROP PROCEDURE IF EXISTS add_column_if_not_exists;
DELIMITER $$
CREATE PROCEDURE add_column_if_not_exists(...)
BEGIN
  -- 存储过程逻辑
END$$
DELIMITER ;

-- ✅ 正确: 使用动态 SQL
SET @column_exists = (...);
SET @sql = IF(...);
PREPARE stmt FROM @sql;
EXECUTE stmt;
```

---

## 💡 最佳实践

### 1. 软删除 vs 物理删除

```sql
-- ✅ 推荐: 软删除(重要数据)
UPDATE `aiot_knowledge_bases` 
SET `is_deleted` = 1, `deleted_at` = NOW() 
WHERE `id` = 123;

-- 查询时过滤已删除数据
SELECT * FROM `aiot_knowledge_bases` WHERE `is_deleted` = 0;

-- ❌ 物理删除(谨慎使用,仅用于临时数据)
DELETE FROM `aiot_knowledge_bases` WHERE `id` = 123;
```

### 2. 外键约束

```sql
-- 外键约束确保数据一致性,但可能影响性能
-- 建议: 重要关系使用外键,其他通过应用层保证

-- ✅ 使用外键(推荐场景: 级联删除)
ALTER TABLE `aiot_knowledge_bases`
ADD CONSTRAINT `fk_kb_owner`
FOREIGN KEY (`owner_id`) REFERENCES `aiot_core_users` (`id`)
ON DELETE CASCADE
ON UPDATE CASCADE;

-- ✅ 不使用外键(推荐场景: 高性能要求)
-- 在应用层保证数据一致性
KEY `idx_school_id` (`school_id`)  -- 只建立索引
```

### 3. 字段默认值

```sql
-- ✅ 合理设置默认值
`status` VARCHAR(20) DEFAULT 'draft'
`is_active` TINYINT(1) DEFAULT 1
`student_count` INT(11) DEFAULT 0
`created_at` DATETIME DEFAULT CURRENT_TIMESTAMP

-- ❌ 避免使用 NULL 作为默认值(除非必要)
`description` TEXT DEFAULT NULL  -- NULL 可能导致查询复杂
```

### 4. 字符集和排序规则

```sql
-- ✅ 推荐配置(支持中文和 Emoji)
CREATE TABLE `aiot_knowledge_bases` (
  ...
) ENGINE=InnoDB 
  DEFAULT CHARSET=utf8mb4 
  COLLATE=utf8mb4_unicode_ci;

-- utf8mb4: 支持所有 Unicode 字符(包括 Emoji)
-- utf8mb4_unicode_ci: 不区分大小写的排序规则
```

### 5. 表引擎选择

```sql
-- ✅ InnoDB(推荐): 支持事务、外键、行级锁
ENGINE=InnoDB

-- ❌ MyISAM(不推荐): 不支持事务,表级锁
```

---

## 📚 参考资源

- [MySQL 5.7 官方文档](https://dev.mysql.com/doc/refman/5.7/en/)
- [MySQL 8.0 官方文档](https://dev.mysql.com/doc/refman/8.0/en/)
- 项目 SQL 脚本: `SQL/init_database.sql`
- 更新脚本示例: `SQL/update/`

---

**记住**: 良好的数据库设计是系统稳定性和性能的基础！
