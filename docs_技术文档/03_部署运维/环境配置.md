# 环境配置管理

## 概述

环境配置是项目开发和部署的基础，正确的配置管理能避免大量问题。本文档详细介绍 CodeHubot 项目的环境变量配置、管理方法和最佳实践。

## 为什么需要环境变量？

### 传统硬编码的问题

```python
# ❌ 硬编码（不推荐）
DB_HOST = "localhost"
DB_PASSWORD = "admin123"  # 密码暴露在代码中
API_KEY = "sk-xxx"        # API密钥泄露风险
```

### 环境变量的优势

```python
# ✅ 使用环境变量
import os

DB_HOST = os.getenv("DB_HOST", "localhost")
DB_PASSWORD = os.getenv("DB_PASSWORD")
API_KEY = os.getenv("API_KEY")
```

**优势**：
- ✅ 敏感信息不进入代码库
- ✅ 不同环境使用不同配置
- ✅ 配置集中管理
- ✅ 符合 12-Factor 规范

## 配置文件结构

### 后端配置

```
backend/
├── .env                    # 本地环境配置（不提交）
├── .env.example           # 配置模板（提交到 Git）
├── .env.development       # 开发环境配置
├── .env.production        # 生产环境配置
└── app/
    └── core/
        └── config.py      # 配置管理类
```

### 前端配置

```
frontend/
├── .env                    # 本地环境配置
├── .env.development       # 开发环境配置
├── .env.production        # 生产环境配置
└── vite.config.js         # Vite 配置文件
```

## 后端配置详解

### 1. .env.example 模板

```bash
# ==========================================
# CodeHubot 后端环境配置模板
# ==========================================

# ========== 应用配置 ==========
APP_NAME=CodeHubot
APP_ENV=development          # development/production
DEBUG=true                   # 调试模式

# ========== 数据库配置 ==========
DB_HOST=localhost
DB_PORT=3306
DB_USER=root
DB_PASSWORD=your_password    # ⚠️ 请修改密码
DB_NAME=aiot_admin

# ========== Redis 配置 ==========
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_DB=0
REDIS_PASSWORD=              # Redis 密码（可选）

# ========== JWT 配置 ==========
SECRET_KEY=your-secret-key-change-this-in-production  # ⚠️ 生产环境必须修改
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=1440    # 24小时
REFRESH_TOKEN_EXPIRE_DAYS=30        # 30天

# ========== MQTT 配置 ==========
MQTT_BROKER=localhost
MQTT_PORT=1883
MQTT_USERNAME=
MQTT_PASSWORD=

# ========== Celery 配置 ==========
CELERY_BROKER_URL=redis://localhost:6379/0
CELERY_RESULT_BACKEND=redis://localhost:6379/1

# ========== 大模型配置 ==========
# OpenAI
OPENAI_API_KEY=
OPENAI_BASE_URL=https://api.openai.com/v1

# 文心一言
QIANFAN_ACCESS_KEY=
QIANFAN_SECRET_KEY=

# 通义千问
DASHSCOPE_API_KEY=

# ========== 阿里云配置 ==========
ALIYUN_ACCESS_KEY_ID=
ALIYUN_ACCESS_KEY_SECRET=
ALIYUN_VOD_REGION=cn-shanghai

# ========== 邮件配置 ==========
MAIL_SERVER=smtp.gmail.com
MAIL_PORT=587
MAIL_USERNAME=
MAIL_PASSWORD=
MAIL_FROM=noreply@example.com
MAIL_USE_TLS=true

# ========== 文件上传配置 ==========
UPLOAD_DIR=uploads
MAX_UPLOAD_SIZE=10485760     # 10MB

# ========== CORS 配置 ==========
ALLOWED_ORIGINS=http://localhost:3000,http://localhost:5173
```

### 2. config.py 配置类

```python
# backend/app/core/config.py
from pydantic_settings import BaseSettings
from typing import List, Optional
from functools import lru_cache

class Settings(BaseSettings):
    """应用配置"""
    
    # ========== 应用配置 ==========
    APP_NAME: str = "CodeHubot"
    APP_ENV: str = "development"
    DEBUG: bool = False
    
    # ========== 数据库配置 ==========
    DB_HOST: str = "localhost"
    DB_PORT: int = 3306
    DB_USER: str = "root"
    DB_PASSWORD: str
    DB_NAME: str = "aiot_admin"
    
    @property
    def DATABASE_URL(self) -> str:
        """数据库连接URL"""
        return (
            f"mysql+pymysql://{self.DB_USER}:{self.DB_PASSWORD}"
            f"@{self.DB_HOST}:{self.DB_PORT}/{self.DB_NAME}"
            f"?charset=utf8mb4"
        )
    
    # ========== Redis 配置 ==========
    REDIS_HOST: str = "localhost"
    REDIS_PORT: int = 6379
    REDIS_DB: int = 0
    REDIS_PASSWORD: Optional[str] = None
    
    @property
    def REDIS_URL(self) -> str:
        """Redis 连接URL"""
        if self.REDIS_PASSWORD:
            return f"redis://:{self.REDIS_PASSWORD}@{self.REDIS_HOST}:{self.REDIS_PORT}/{self.REDIS_DB}"
        return f"redis://{self.REDIS_HOST}:{self.REDIS_PORT}/{self.REDIS_DB}"
    
    # ========== JWT 配置 ==========
    SECRET_KEY: str
    ALGORITHM: str = "HS256"
    ACCESS_TOKEN_EXPIRE_MINUTES: int = 1440
    REFRESH_TOKEN_EXPIRE_DAYS: int = 30
    
    # ========== MQTT 配置 ==========
    MQTT_BROKER: str = "localhost"
    MQTT_PORT: int = 1883
    MQTT_USERNAME: Optional[str] = None
    MQTT_PASSWORD: Optional[str] = None
    
    # ========== Celery 配置 ==========
    CELERY_BROKER_URL: str = "redis://localhost:6379/0"
    CELERY_RESULT_BACKEND: str = "redis://localhost:6379/1"
    
    # ========== 大模型配置 ==========
    OPENAI_API_KEY: Optional[str] = None
    OPENAI_BASE_URL: str = "https://api.openai.com/v1"
    
    QIANFAN_ACCESS_KEY: Optional[str] = None
    QIANFAN_SECRET_KEY: Optional[str] = None
    
    DASHSCOPE_API_KEY: Optional[str] = None
    
    # ========== 阿里云配置 ==========
    ALIYUN_ACCESS_KEY_ID: Optional[str] = None
    ALIYUN_ACCESS_KEY_SECRET: Optional[str] = None
    ALIYUN_VOD_REGION: str = "cn-shanghai"
    
    # ========== 邮件配置 ==========
    MAIL_SERVER: str = "smtp.gmail.com"
    MAIL_PORT: int = 587
    MAIL_USERNAME: Optional[str] = None
    MAIL_PASSWORD: Optional[str] = None
    MAIL_FROM: str = "noreply@example.com"
    MAIL_USE_TLS: bool = True
    
    # ========== 文件上传 ==========
    UPLOAD_DIR: str = "uploads"
    MAX_UPLOAD_SIZE: int = 10 * 1024 * 1024  # 10MB
    
    # ========== CORS 配置 ==========
    ALLOWED_ORIGINS: List[str] = ["http://localhost:3000"]
    
    class Config:
        # 读取 .env 文件
        env_file = ".env"
        # 区分大小写
        case_sensitive = True
        # 额外配置
        extra = "ignore"

# 使用缓存避免重复读取
@lru_cache()
def get_settings() -> Settings:
    return Settings()

# 导出单例
settings = get_settings()
```

### 3. 使用配置

```python
# 在代码中使用
from app.core.config import settings

# 数据库连接
engine = create_engine(settings.DATABASE_URL)

# Redis 连接
redis_client = redis.from_url(settings.REDIS_URL)

# 检查调试模式
if settings.DEBUG:
    print("运行在调试模式")

# 使用 API Key
openai.api_key = settings.OPENAI_API_KEY
```

## 前端配置详解

### 1. .env 文件

```bash
# ==========================================
# CodeHubot 前端环境配置
# ==========================================

# ========== 应用配置 ==========
VITE_APP_TITLE=CodeHubot
VITE_APP_ENV=development

# ========== API 配置 ==========
VITE_API_BASE_URL=http://localhost:8000/api
VITE_WS_URL=ws://localhost:8000/ws

# ========== 功能开关 ==========
VITE_ENABLE_MOCK=false
VITE_ENABLE_DEVTOOLS=true

# ========== 第三方服务 ==========
VITE_AMAP_KEY=your_amap_key
```

### 2. .env.development（开发环境）

```bash
VITE_APP_ENV=development
VITE_API_BASE_URL=http://localhost:8000/api
VITE_ENABLE_MOCK=true
VITE_ENABLE_DEVTOOLS=true
```

### 3. .env.production（生产环境）

```bash
VITE_APP_ENV=production
VITE_API_BASE_URL=https://api.example.com/api
VITE_ENABLE_MOCK=false
VITE_ENABLE_DEVTOOLS=false
```

### 4. 在代码中使用

```javascript
// vite.config.js
import { defineConfig, loadEnv } from 'vite'

export default defineConfig(({ mode }) => {
  // 加载环境变量
  const env = loadEnv(mode, process.cwd())
  
  return {
    server: {
      port: 3000,
      proxy: {
        '/api': {
          target: env.VITE_API_BASE_URL,
          changeOrigin: true
        }
      }
    }
  }
})
```

```javascript
// 在组件中使用
const apiBaseUrl = import.meta.env.VITE_API_BASE_URL
const isDev = import.meta.env.DEV
const isProd = import.meta.env.PROD

console.log('API地址:', apiBaseUrl)
console.log('开发模式:', isDev)
```

## Docker 环境配置

### 1. docker-compose.yml

```yaml
version: '3.8'

services:
  backend:
    build: ./backend
    environment:
      # 直接指定
      - APP_ENV=production
      - DEBUG=false
      
      # 从主机环境变量读取
      - DB_PASSWORD=${DB_PASSWORD}
      - SECRET_KEY=${SECRET_KEY}
      
      # 使用 Docker 服务名
      - DB_HOST=mysql
      - REDIS_HOST=redis
      - MQTT_BROKER=mqtt
    
    # 或使用 env_file
    env_file:
      - ./backend/.env.production
    
    depends_on:
      - mysql
      - redis
      - mqtt

  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
      MYSQL_DATABASE: aiot_admin
    volumes:
      - mysql_data:/var/lib/mysql

  redis:
    image: redis:7-alpine
    command: redis-server --requirepass ${REDIS_PASSWORD}

volumes:
  mysql_data:
```

### 2. .env 文件（Docker 主机）

```bash
# docker/.env
DB_PASSWORD=strong_password_here
SECRET_KEY=your-production-secret-key
REDIS_PASSWORD=redis_password_here
```

### 3. 使用 Docker Secrets（推荐）

```yaml
# docker-compose.yml
version: '3.8'

services:
  backend:
    image: backend:latest
    secrets:
      - db_password
      - secret_key
    environment:
      - DB_PASSWORD_FILE=/run/secrets/db_password
      - SECRET_KEY_FILE=/run/secrets/secret_key

secrets:
  db_password:
    file: ./secrets/db_password.txt
  secret_key:
    file: ./secrets/secret_key.txt
```

```python
# 读取 Secret
def read_secret(secret_name):
    secret_file = os.getenv(f"{secret_name.upper()}_FILE")
    if secret_file and os.path.exists(secret_file):
        with open(secret_file) as f:
            return f.read().strip()
    return os.getenv(secret_name)

DB_PASSWORD = read_secret("db_password")
```

## 不同环境的配置

### 开发环境

```bash
# backend/.env.development
APP_ENV=development
DEBUG=true

DB_HOST=localhost
DB_PASSWORD=dev_password

# 使用本地服务
REDIS_HOST=localhost
MQTT_BROKER=localhost

# 启用调试功能
LOG_LEVEL=DEBUG
ENABLE_SQL_LOGGING=true
```

### 测试环境

```bash
# backend/.env.testing
APP_ENV=testing
DEBUG=false

# 使用测试数据库
DB_NAME=aiot_admin_test
DB_HOST=localhost

# 使用 Mock 服务
ENABLE_MOCK=true
OPENAI_API_KEY=mock_key
```

### 生产环境

```bash
# backend/.env.production
APP_ENV=production
DEBUG=false

# 使用生产数据库
DB_HOST=prod-db.example.com
DB_PASSWORD=${DB_PASSWORD}  # 从环境变量读取

# 使用 Docker 服务名
REDIS_HOST=redis
MQTT_BROKER=mqtt

# 安全配置
SECRET_KEY=${SECRET_KEY}
ALLOWED_ORIGINS=https://example.com

# 性能优化
LOG_LEVEL=INFO
ENABLE_SQL_LOGGING=false
```

## 敏感信息管理

### 1. .gitignore 配置

```gitignore
# 环境变量文件
.env
.env.local
.env.*.local

# 但保留模板文件
!.env.example
!.env.*.example

# 密钥文件
secrets/
*.key
*.pem
```

### 2. 使用密钥管理服务

```python
# 使用 AWS Secrets Manager
import boto3

def get_secret(secret_name):
    client = boto3.client('secretsmanager')
    response = client.get_secret_value(SecretId=secret_name)
    return json.loads(response['SecretString'])

# 获取数据库密码
db_secrets = get_secret('prod/database')
DB_PASSWORD = db_secrets['password']
```

### 3. 环境变量加密

```bash
# 使用 git-crypt 加密敏感文件
git-crypt init
git-crypt add-gpg-user user@example.com

# .gitattributes
.env.production filter=git-crypt diff=git-crypt
secrets/* filter=git-crypt diff=git-crypt
```

## 配置验证

### 1. 启动时验证

```python
# backend/app/main.py
from app.core.config import settings

def validate_config():
    """验证必需的配置项"""
    required_configs = [
        ('DB_PASSWORD', settings.DB_PASSWORD),
        ('SECRET_KEY', settings.SECRET_KEY),
    ]
    
    missing = []
    for name, value in required_configs:
        if not value or value == 'your_password':
            missing.append(name)
    
    if missing:
        raise ValueError(
            f"缺少必需的配置项: {', '.join(missing)}\n"
            f"请检查 .env 文件"
        )

# 应用启动时验证
@asynccontextmanager
async def lifespan(app: FastAPI):
    validate_config()
    print("✅ 配置验证通过")
    yield
```

### 2. 配置检查脚本

```python
# scripts/check_config.py
from app.core.config import settings

def check_config():
    """检查配置完整性"""
    print("=" * 50)
    print("配置检查")
    print("=" * 50)
    
    # 检查数据库
    print(f"数据库: {settings.DB_HOST}:{settings.DB_PORT}")
    if settings.DB_PASSWORD == "your_password":
        print("⚠️  警告: 数据库密码未修改")
    
    # 检查密钥
    if settings.SECRET_KEY.startswith("your-secret"):
        print("⚠️  警告: SECRET_KEY 未修改")
    else:
        print(f"✅ SECRET_KEY: {settings.SECRET_KEY[:10]}...")
    
    # 检查API密钥
    if settings.OPENAI_API_KEY:
        print(f"✅ OpenAI API Key: {settings.OPENAI_API_KEY[:10]}...")
    else:
        print("⚠️  OpenAI API Key 未配置")
    
    print("=" * 50)

if __name__ == "__main__":
    check_config()
```

## 最佳实践

### 1. 配置命名规范

```bash
# ✅ 好的命名
DB_HOST=localhost
DB_PORT=3306
REDIS_HOST=localhost

# ❌ 不好的命名
database_host=localhost
DatabasePort=3306
redis-host=localhost
```

### 2. 默认值设置

```python
# ✅ 提供合理的默认值
DB_PORT: int = 3306
REDIS_PORT: int = 6379
LOG_LEVEL: str = "INFO"

# ❌ 敏感信息不要有默认值
DB_PASSWORD: str  # 必须提供
SECRET_KEY: str   # 必须提供
```

### 3. 文档注释

```bash
# ========== 数据库配置 ==========
# DB_HOST: 数据库主机地址
#   - 开发环境: localhost
#   - Docker环境: mysql
#   - 生产环境: prod-db.example.com
DB_HOST=localhost

# DB_PORT: 数据库端口，默认 3306
DB_PORT=3306
```

### 4. 环境变量优先级

```python
# 优先级: 系统环境变量 > .env 文件 > 默认值
class Settings(BaseSettings):
    DB_HOST: str = "localhost"  # 默认值
    
    class Config:
        env_file = ".env"  # 从文件读取
        # 系统环境变量优先级最高
```

## 常见问题

### 1. 配置未生效

```python
# ❌ 问题：修改 .env 文件后未生效
# 原因：使用了 @lru_cache 缓存

# ✅ 解决：重启应用
# 或者移除缓存装饰器（开发环境）
```

### 2. Docker 中环境变量

```yaml
# ❌ 错误：使用 localhost
services:
  backend:
    environment:
      - DB_HOST=localhost  # Docker 中无法访问

# ✅ 正确：使用服务名
services:
  backend:
    environment:
      - DB_HOST=mysql  # Docker 服务名
```

### 3. 敏感信息泄露

```bash
# ✅ 检查是否提交了敏感文件
git log --all --full-history -- .env

# 如果误提交，从历史中删除
git filter-branch --force --index-filter \
  "git rm --cached --ignore-unmatch .env" \
  --prune-empty --tag-name-filter cat -- --all
```

## 教学要点总结

### 核心概念
1. **环境变量**: 配置与代码分离
2. **配置管理**: .env 文件、Pydantic Settings
3. **多环境配置**: development/testing/production
4. **敏感信息**: 密钥管理、加密存储
5. **Docker 配置**: 环境变量、Secrets

### 实用技能
- ✅ 创建和使用 .env 文件
- ✅ Pydantic Settings 配置类
- ✅ Docker 环境变量传递
- ✅ 配置验证和检查
- ✅ 敏感信息安全管理

### 最佳实践
- ✅ 使用 .env.example 模板
- ✅ .env 文件加入 .gitignore
- ✅ 配置项有清晰注释
- ✅ 启动时验证必需配置
- ✅ 生产环境使用密钥管理

## 相关文档

- [本地开发环境](../04_开发调试/本地开发环境.md) - 开发环境搭建
- [Docker容器化部署](./Docker容器化部署.md) - Docker 配置
- [常见问题排查](../04_开发调试/常见问题排查.md) - 配置问题排查
