# 前端架构设计

## 概述

CodeHubot 前端采用 Vue 3 + Vite + Element Plus 构建，使用模块化架构设计，支持多业务模块独立开发和部署。本文档详细介绍前端架构设计，适合教学和实际开发使用。

## 技术栈

### 核心框架

```json
{
  "vue": "^3.4.0",           // 渐进式前端框架
  "vue-router": "^4.3.0",    // 官方路由管理
  "pinia": "^2.1.7",         // 官方状态管理
  "vite": "^5.0.0"           // 新一代构建工具
}
```

### UI 组件库

```json
{
  "element-plus": "^2.5.0",              // 桌面端组件库
  "@element-plus/icons-vue": "^2.3.1"    // Element Plus 图标
}
```

### 工具库

```json
{
  "axios": "^1.6.0",           // HTTP 客户端
  "echarts": "^6.0.0",         // 图表库
  "@vue-flow/core": "^1.33.0", // 流程图编辑器
  "marked": "^11.0.0"          // Markdown 解析器
}

## 项目结构

```
frontend/
├── public/                          # 静态资源
├── src/
│   ├── main.js                      # 应用入口
│   ├── App.vue                      # 根组件
│   │
│   ├── api/                         # API 接口层
│   │   ├── request.js               # Axios 封装
│   │   ├── auth.js                  # 认证相关 API
│   │   ├── device.js                # 设备管理 API
│   │   ├── agent.js                 # AI 助手 API
│   │   └── ...                      # 其他业务 API
│   │
│   ├── router/                      # 路由配置
│   │   ├── index.js                 # 路由汇总
│   │   ├── ai.js                    # AI 模块路由
│   │   ├── device.js                # 设备模块路由
│   │   └── pbl.js                   # PBL 模块路由
│   │
│   ├── stores/                      # Pinia 状态管理
│   │   ├── auth.js                  # 认证状态
│   │   └── user.js                  # 用户状态
│   │
│   ├── modules/                     # 业务模块
│   │   ├── device/                  # 设备管理模块
│   │   │   ├── views/               # 页面组件
│   │   │   ├── components/          # 业务组件
│   │   │   └── composables/         # 组合式函数
│   │   │
│   │   ├── ai/                      # AI 助手模块
│   │   │   ├── views/
│   │   │   ├── components/
│   │   │   └── composables/
│   │   │
│   │   └── pbl/                     # PBL 教学模块
│   │       ├── student/             # 学生端
│   │       ├── teacher/             # 教师端
│   │       └── admin/               # 管理端
│   │
│   ├── components/                  # 通用组件
│   │   ├── device/                  # 设备相关组件
│   │   └── ...                      # 其他通用组件
│   │
│   ├── layouts/                     # 布局组件
│   │   ├── AILayout.vue             # AI 模块布局
│   │   ├── DeviceLayout.vue         # 设备模块布局
│   │   ├── PBLStudentLayout.vue     # PBL 学生布局
│   │   └── ...                      # 其他布局
│   │
│   ├── utils/                       # 工具函数
│   │   ├── request.js               # HTTP 请求封装
│   │   ├── auth.js                  # 认证工具
│   │   ├── logger.js                # 日志工具
│   │   ├── apiHelper.js             # API 辅助函数
│   │   └── responseHandler.js       # 响应处理
│   │
│   ├── shared/                      # 共享资源
│   │   ├── api/                     # 共享 API
│   │   └── utils/                   # 共享工具
│   │
│   └── views/                       # 全局页面
│       ├── Login.vue                # 登录页
│       ├── Portal.vue               # 门户页
│       └── NotFound.vue             # 404 页面
│
├── vite.config.js                   # Vite 配置
├── package.json                     # 项目配置
├── Dockerfile                       # Docker 构建
└── nginx.conf                       # Nginx 配置
```

## 架构设计

### 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    CodeHubot 前端架构                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              视图层 (Views/Pages)                    │   │
│  │  ┌──────┐  ┌──────┐  ┌──────┐  ┌──────┐            │   │
│  │  │设备  │  │ AI   │  │ PBL  │  │用户  │            │   │
│  │  │管理  │  │助手  │  │教学  │  │管理  │            │   │
│  │  └──────┘  └──────┘  └──────┘  └──────┘            │   │
│  └─────────────┬───────────────────────────────────────┘   │
│                │                                            │
│  ┌─────────────┴───────────────────────────────────────┐   │
│  │            组件层 (Components)                      │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐          │   │
│  │  │通用组件  │  │业务组件  │  │布局组件  │          │   │
│  │  └──────────┘  └──────────┘  └──────────┘          │   │
│  └─────────────┬───────────────────────────────────────┘   │
│                │                                            │
│  ┌─────────────┴───────────────────────────────────────┐   │
│  │        组合式函数层 (Composables)                   │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐          │   │
│  │  │业务逻辑  │  │状态管理  │  │工具函数  │          │   │
│  │  └──────────┘  └──────────┘  └──────────┘          │   │
│  └─────────────┬───────────────────────────────────────┘   │
│                │                                            │
│  ┌─────────────┴───────────────────────────────────────┐   │
│  │              状态管理 (Pinia)                       │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐          │   │
│  │  │认证状态  │  │用户状态  │  │业务状态  │          │   │
│  │  └──────────┘  └──────────┘  └──────────┘          │   │
│  └─────────────┬───────────────────────────────────────┘   │
│                │                                            │
│  ┌─────────────┴───────────────────────────────────────┐   │
│  │              API 接口层 (Axios)                     │   │
│  │  ┌──────────────────────────────────────────────┐   │   │
│  │  │  请求拦截 → 发送请求 → 响应拦截 → 错误处理  │   │   │
│  │  └──────────────────────────────────────────────┘   │   │
│  └─────────────┬───────────────────────────────────────┘   │
│                │                                            │
│                ↓                                            │
│          后端 API 服务                                      │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 模块化设计

CodeHubot 采用模块化架构，每个业务模块独立开发：

```
modules/
├── device/                    # 设备管理模块
│   ├── views/
│   │   ├── DeviceList.vue
│   │   ├── DeviceDetail.vue
│   │   └── DeviceControl.vue
│   ├── components/
│   │   ├── DeviceCard.vue
│   │   └── DeviceChart.vue
│   └── composables/
│       └── useDevice.js
│
├── ai/                        # AI 助手模块
│   ├── views/
│   ├── components/
│   └── composables/
│
└── pbl/                       # PBL 教学模块
    ├── student/               # 学生子模块
    ├── teacher/               # 教师子模块
    └── admin/                 # 管理子模块
```

## 核心配置

### 1. 应用入口 (main.js)

```javascript
import { createApp } from 'vue'
import { createPinia } from 'pinia'
import ElementPlus from 'element-plus'
import 'element-plus/dist/index.css'
import * as ElementPlusIconsVue from '@element-plus/icons-vue'
import zhCn from 'element-plus/es/locale/lang/zh-cn'

import App from './App.vue'
import router from './router'
import { useAuthStore } from './stores/auth'

// 创建应用实例
const app = createApp(App)

// 使用 Pinia 状态管理
const pinia = createPinia()
app.use(pinia)

// 初始化认证状态
const authStore = useAuthStore()
authStore.init()

// 使用路由
app.use(router)

// 使用 Element Plus（中文）
app.use(ElementPlus, {
  locale: zhCn,
  size: 'default'
})

// 注册所有图标组件
for (const [key, component] of Object.entries(ElementPlusIconsVue)) {
  app.component(key, component)
}

// 全局错误处理
app.config.errorHandler = (err, instance, info) => {
  console.error('全局错误:', err, info)
}

// 挂载应用
app.mount('#app')
```

### 2. Vite 配置 (vite.config.js)

```javascript
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'
import { resolve } from 'path'

export default defineConfig({
  plugins: [vue()],
  
  // 路径别名
  resolve: {
    alias: {
      '@': resolve(__dirname, 'src'),
      '@device': resolve(__dirname, 'src/modules/device'),
      '@ai': resolve(__dirname, 'src/modules/ai'),
      '@pbl': resolve(__dirname, 'src/modules/pbl'),
      '@shared': resolve(__dirname, 'src/shared')
    }
  },
  
  // CSS 预处理器
  css: {
    preprocessorOptions: {
      scss: {
        api: 'modern-compiler'
      }
    }
  },
  
  // 开发服务器
  server: {
    port: 3000,
    proxy: {
      '/api': {
        target: 'http://localhost:8000',
        changeOrigin: true
      }
    }
  },
  
  // 生产构建优化
  build: {
    minify: 'terser',
    terserOptions: {
      compress: {
        drop_console: true,      // 删除 console
        drop_debugger: true      // 删除 debugger
      }
    },
    
    // 代码分割
    rollupOptions: {
      output: {
        manualChunks(id) {
          // Element Plus 单独打包
          if (id.includes('node_modules/element-plus')) {
            return 'element-plus'
          }
          // Vue 核心库单独打包
          if (id.includes('node_modules/vue')) {
            return 'vue-vendor'
          }
          // 业务模块分别打包
          if (id.includes('/src/modules/device/')) {
            return 'module-device'
          }
          if (id.includes('/src/modules/ai/')) {
            return 'module-ai'
          }
          if (id.includes('/src/modules/pbl/')) {
            return 'module-pbl'
          }
          // 其他第三方库
          if (id.includes('node_modules')) {
            return 'vendor'
          }
        }
      }
    }
  }
})
```

## 路由设计

### 路由结构

```javascript
// router/index.js
import { createRouter, createWebHistory } from 'vue-router'
import { useAuthStore } from '@/stores/auth'

// 导入各模块路由
import aiRoutes from './ai'
import deviceRoutes from './device'
import pblRoutes from './pbl'

const routes = [
  {
    path: '/',
    name: 'Portal',
    component: () => import('@/views/Portal.vue')
  },
  {
    path: '/login',
    name: 'Login',
    component: () => import('@/views/Login.vue')
  },
  
  // AI 模块路由
  ...aiRoutes,
  
  // 设备模块路由
  ...deviceRoutes,
  
  // PBL 模块路由
  ...pblRoutes,
  
  // 404
  {
    path: '/:pathMatch(.*)*',
    name: 'NotFound',
    component: () => import('@/views/NotFound.vue')
  }
]

const router = createRouter({
  history: createWebHistory(),
  routes
})

// 全局路由守卫
router.beforeEach((to, from, next) => {
  const authStore = useAuthStore()
  
  // 白名单（无需登录）
  const whitelist = ['/login', '/']
  
  if (whitelist.includes(to.path)) {
    next()
  } else if (authStore.isAuthenticated) {
    // 已登录，检查权限
    if (to.meta.roles && !to.meta.roles.includes(authStore.role)) {
      next('/403')
    } else {
      next()
    }
  } else {
    // 未登录，跳转登录页
    next(`/login?redirect=${to.fullPath}`)
  }
})

export default router
```

### 模块路由示例

```javascript
// router/device.js
import DeviceLayout from '@/layouts/DeviceLayout.vue'

export default [
  {
    path: '/device',
    component: DeviceLayout,
    meta: { requiresAuth: true },
    children: [
      {
        path: '',
        name: 'DeviceList',
        component: () => import('@device/views/DeviceList.vue'),
        meta: { 
          title: '设备列表',
          roles: ['admin', 'teacher', 'student']
        }
      },
      {
        path: ':id',
        name: 'DeviceDetail',
        component: () => import('@device/views/DeviceDetail.vue'),
        meta: { 
          title: '设备详情',
          roles: ['admin', 'teacher', 'student']
        }
      },
      {
        path: ':id/control',
        name: 'DeviceControl',
        component: () => import('@device/views/DeviceControl.vue'),
        meta: { 
          title: '设备控制',
          roles: ['admin', 'teacher']
        }
      }
    ]
  }
]
```

## 状态管理（Pinia）

### 认证状态

```javascript
// stores/auth.js
import { defineStore } from 'pinia'
import { ref, computed } from 'vue'
import { login, logout, refreshToken } from '@/api/auth'

export const useAuthStore = defineStore('auth', () => {
  // 状态
  const accessToken = ref(null)
  const refreshTokenValue = ref(null)
  const user = ref(null)
  const role = ref(null)
  
  // 计算属性
  const isAuthenticated = computed(() => !!accessToken.value)
  const isAdmin = computed(() => role.value === 'admin')
  const isTeacher = computed(() => role.value === 'teacher')
  const isStudent = computed(() => role.value === 'student')
  
  // 初始化（从 localStorage 恢复）
  function init() {
    accessToken.value = localStorage.getItem('access_token')
    refreshTokenValue.value = localStorage.getItem('refresh_token')
    const userStr = localStorage.getItem('user')
    if (userStr) {
      user.value = JSON.parse(userStr)
      role.value = user.value.role
    }
  }
  
  // 登录
  async function loginAction(credentials) {
    try {
      const response = await login(credentials)
      const { access_token, refresh_token, user: userData } = response.data
      
      // 保存状态
      accessToken.value = access_token
      refreshTokenValue.value = refresh_token
      user.value = userData
      role.value = userData.role
      
      // 持久化
      localStorage.setItem('access_token', access_token)
      localStorage.setItem('refresh_token', refresh_token)
      localStorage.setItem('user', JSON.stringify(userData))
      
      return true
    } catch (error) {
      console.error('登录失败:', error)
      return false
    }
  }
  
  // 登出
  async function logoutAction() {
    try {
      await logout()
    } finally {
      // 清除状态
      accessToken.value = null
      refreshTokenValue.value = null
      user.value = null
      role.value = null
      
      // 清除持久化
      localStorage.removeItem('access_token')
      localStorage.removeItem('refresh_token')
      localStorage.removeItem('user')
    }
  }
  
  // 刷新 Token
  async function refreshTokenAction() {
    try {
      const response = await refreshToken(refreshTokenValue.value)
      const { access_token } = response.data
      
      accessToken.value = access_token
      localStorage.setItem('access_token', access_token)
      
      return access_token
    } catch (error) {
      // 刷新失败，清除登录状态
      await logoutAction()
      throw error
    }
  }
  
  return {
    // 状态
    accessToken,
    refreshTokenValue,
    user,
    role,
    // 计算属性
    isAuthenticated,
    isAdmin,
    isTeacher,
    isStudent,
    // 方法
    init,
    loginAction,
    logoutAction,
    refreshTokenAction
  }
})
```

### 业务状态示例

```javascript
// stores/device.js
import { defineStore } from 'pinia'
import { ref } from 'vue'
import { getDeviceList, getDeviceDetail } from '@/api/device'

export const useDeviceStore = defineStore('device', () => {
  const devices = ref([])
  const currentDevice = ref(null)
  const loading = ref(false)
  
  async function fetchDevices(params) {
    loading.value = true
    try {
      const response = await getDeviceList(params)
      devices.value = response.data.items
      return response.data
    } finally {
      loading.value = false
    }
  }
  
  async function fetchDeviceDetail(id) {
    loading.value = true
    try {
      const response = await getDeviceDetail(id)
      currentDevice.value = response.data
      return response.data
    } finally {
      loading.value = false
    }
  }
  
  return {
    devices,
    currentDevice,
    loading,
    fetchDevices,
    fetchDeviceDetail
  }
})
```

## API 封装

### Axios 配置

```javascript
// utils/request.js
import axios from 'axios'
import { ElMessage } from 'element-plus'
import { useAuthStore } from '@/stores/auth'
import router from '@/router'

// 创建 axios 实例
const request = axios.create({
  baseURL: '/api',
  timeout: 30000
})

// 请求拦截器
request.interceptors.request.use(
  config => {
    const authStore = useAuthStore()
    
    // 添加 Token
    if (authStore.accessToken) {
      config.headers.Authorization = `Bearer ${authStore.accessToken}`
    }
    
    return config
  },
  error => {
    console.error('请求错误:', error)
    return Promise.reject(error)
  }
)

// 响应拦截器
request.interceptors.response.use(
  response => {
    // 统一处理响应
    const { data } = response
    
    if (data.success) {
      return data
    } else {
      ElMessage.error(data.message || '请求失败')
      return Promise.reject(new Error(data.message))
    }
  },
  async error => {
    const { response, config } = error
    
    if (!response) {
      ElMessage.error('网络错误，请检查网络连接')
      return Promise.reject(error)
    }
    
    // Token 过期，尝试刷新
    if (response.status === 401 && !config._retry) {
      config._retry = true
      
      try {
        const authStore = useAuthStore()
        const newToken = await authStore.refreshTokenAction()
        
        // 使用新 Token 重试请求
        config.headers.Authorization = `Bearer ${newToken}`
        return request(config)
      } catch (refreshError) {
        // 刷新失败，跳转登录页
        router.push('/login')
        return Promise.reject(refreshError)
      }
    }
    
    // 其他错误
    const errorMessage = response.data?.message || '请求失败'
    ElMessage.error(errorMessage)
    
    return Promise.reject(error)
  }
)

export default request
```

### API 接口定义

```javascript
// api/device.js
import request from '@/utils/request'

// 获取设备列表
export function getDeviceList(params) {
  return request({
    url: '/devices',
    method: 'get',
    params
  })
}

// 获取设备详情
export function getDeviceDetail(id) {
  return request({
    url: `/devices/${id}`,
    method: 'get'
  })
}

// 创建设备
export function createDevice(data) {
  return request({
    url: '/devices',
    method: 'post',
    data
  })
}

// 更新设备
export function updateDevice(id, data) {
  return request({
    url: `/devices/${id}`,
    method: 'put',
    data
  })
}

// 删除设备
export function deleteDevice(id) {
  return request({
    url: `/devices/${id}`,
    method: 'delete'
  })
}

// 控制设备
export function controlDevice(id, command, params) {
  return request({
    url: `/devices/${id}/control`,
    method: 'post',
    data: { command, params }
  })
}
```

## 组件设计

### 布局组件

```vue
<!-- layouts/DeviceLayout.vue -->
<template>
  <div class="device-layout">
    <!-- 顶部导航 -->
    <el-header>
      <h1>设备管理系统</h1>
      <div class="user-info">
        <el-avatar :src="user.avatar" />
        <span>{{ user.name }}</span>
        <el-button @click="handleLogout">登出</el-button>
      </div>
    </el-header>
    
    <el-container>
      <!-- 侧边栏 -->
      <el-aside width="200px">
        <el-menu router :default-active="$route.path">
          <el-menu-item index="/device">
            <el-icon><List /></el-icon>
            <span>设备列表</span>
          </el-menu-item>
          <el-menu-item index="/device/groups">
            <el-icon><Folder /></el-icon>
            <span>设备分组</span>
          </el-menu-item>
          <el-menu-item index="/device/logs">
            <el-icon><Document /></el-icon>
            <span>操作日志</span>
          </el-menu-item>
        </el-menu>
      </el-aside>
      
      <!-- 主内容区 -->
      <el-main>
        <router-view />
      </el-main>
    </el-container>
  </div>
</template>

<script setup>
import { computed } from 'vue'
import { useAuthStore } from '@/stores/auth'
import { useRouter } from 'vue-router'

const authStore = useAuthStore()
const router = useRouter()

const user = computed(() => authStore.user)

const handleLogout = async () => {
  await authStore.logoutAction()
  router.push('/login')
}
</script>
```

### 业务组件示例

```vue
<!-- modules/device/components/DeviceCard.vue -->
<template>
  <el-card class="device-card" :class="{ online: device.online }">
    <template #header>
      <div class="card-header">
        <span>{{ device.name }}</span>
        <el-tag :type="device.online ? 'success' : 'danger'">
          {{ device.online ? '在线' : '离线' }}
        </el-tag>
      </div>
    </template>
    
    <div class="device-info">
      <p>类型: {{ device.device_type }}</p>
      <p>最后在线: {{ formatTime(device.last_seen) }}</p>
    </div>
    
    <template #footer>
      <el-button text @click="viewDetail">查看详情</el-button>
      <el-button v-if="device.online" text type="primary" @click="control">
        控制
      </el-button>
    </template>
  </el-card>
</template>

<script setup>
import { defineProps, defineEmits } from 'vue'
import { useRouter } from 'vue-router'

const props = defineProps({
  device: {
    type: Object,
    required: true
  }
})

const emit = defineEmits(['control'])
const router = useRouter()

const viewDetail = () => {
  router.push(`/device/${props.device.id}`)
}

const control = () => {
  emit('control', props.device)
}

const formatTime = (time) => {
  return new Date(time).toLocaleString('zh-CN')
}
</script>

<style scoped>
.device-card {
  margin-bottom: 16px;
}

.device-card.online {
  border-left: 3px solid #67c23a;
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}
</style>
```

## 组合式函数 (Composables)

```javascript
// modules/device/composables/useDevice.js
import { ref } from 'vue'
import { ElMessage } from 'element-plus'
import { getDeviceDetail, controlDevice } from '@/api/device'

export function useDevice(deviceId) {
  const device = ref(null)
  const loading = ref(false)
  
  // 获取设备详情
  const fetchDevice = async () => {
    loading.value = true
    try {
      const response = await getDeviceDetail(deviceId)
      device.value = response.data
    } catch (error) {
      ElMessage.error('获取设备信息失败')
    } finally {
      loading.value = false
    }
  }
  
  // 控制设备
  const sendCommand = async (command, params) => {
    loading.value = true
    try {
      await controlDevice(deviceId, command, params)
      ElMessage.success('指令发送成功')
      await fetchDevice() // 刷新设备状态
    } catch (error) {
      ElMessage.error('指令发送失败')
    } finally {
      loading.value = false
    }
  }
  
  return {
    device,
    loading,
    fetchDevice,
    sendCommand
  }
}
```

## 性能优化

### 1. 代码分割

```javascript
// 路由懒加载
{
  path: '/device',
  component: () => import('@/modules/device/views/DeviceList.vue')
}

// Vite 动态导入
const DeviceCard = defineAsyncComponent(() =>
  import('@/modules/device/components/DeviceCard.vue')
)
```

### 2. 组件缓存

```vue
<template>
  <router-view v-slot="{ Component }">
    <keep-alive :include="['DeviceList', 'DeviceDetail']">
      <component :is="Component" />
    </keep-alive>
  </router-view>
</template>
```

### 3. 虚拟滚动

```vue
<template>
  <el-table-v2
    :columns="columns"
    :data="largeDataSet"
    :width="700"
    :height="400"
  />
</template>
```

## 教学要点总结

### 核心概念
1. **模块化设计**: 业务模块独立开发
2. **组件化开发**: 可复用组件
3. **状态管理**: Pinia 集中管理状态
4. **路由管理**: Vue Router 页面导航
5. **API 封装**: 统一请求处理

### 最佳实践
- ✅ 使用 Composition API
- ✅ 组件职责单一
- ✅ 提取可复用逻辑到 Composables
- ✅ 合理使用状态管理
- ✅ 代码分割和懒加载

### 适合讲授
- Vue 3 前端开发
- 前端架构设计
- 状态管理
- 组件化开发
- 性能优化

## 相关文档

- [Vue3组合式API](../05_核心技术/Vue3组合式API.md) - Composition API 详解
- [整体架构设计](./整体架构设计.md) - 系统架构
- [API测试](../04_开发调试/API测试.md) - 前后端联调
