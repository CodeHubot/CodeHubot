# 整体架构设计

## 系统概述

CodeHubot 是一个基于微服务架构的 AI-IoT 智能教学平台，采用前后端分离设计，支持容器化部署。系统整合了 Web 应用、物联网设备管理、大语言模型、异步任务处理等多个技术模块。

## 架构全景图

```
┌─────────────────────────────────────────────────────────────────┐
│                         用户层 (User Layer)                      │
├─────────────────────────────────────────────────────────────────┤
│  Web浏览器    │  移动设备    │  ESP32设备    │  第三方系统      │
└────────┬──────┴──────┬───────┴──────┬────────┴────────┬─────────┘
         │ HTTPS       │ HTTPS        │ MQTT            │ API
         │             │              │                 │
┌────────┴─────────────┴──────────────┴─────────────────┴─────────┐
│                      接入层 (Access Layer)                       │
├─────────────────────────────────────────────────────────────────┤
│              Nginx 反向代理 + SSL 终止 + 负载均衡                │
└────────┬────────────────────────────────────────────────────────┘
         │
┌────────┴────────────────────────────────────────────────────────┐
│                     应用层 (Application Layer)                   │
├─────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │   前端服务    │  │   后端服务    │  │  MQTT服务    │          │
│  │  Vue 3 SPA   │  │  FastAPI     │  │  Mosquitto   │          │
│  │  + Vite      │  │  Python 3.11 │  │  MQTT Broker │          │
│  └──────────────┘  └──────┬───────┘  └──────┬───────┘          │
│                           │                  │                  │
│  ┌──────────────┐  ┌─────┴──────┐  ┌────────┴──────┐           │
│  │  Celery任务   │  │ Plugin服务 │  │  配置服务     │           │
│  │  异步队列     │  │  插件后端  │  │  Config API   │           │
│  └──────┬───────┘  └──────┬─────┘  └───────────────┘           │
└─────────┴──────────────────┴─────────────────────────────────────┘
          │                  │
┌─────────┴──────────────────┴─────────────────────────────────────┐
│                      数据层 (Data Layer)                          │
├─────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │  MySQL 8.0   │  │  Redis 7     │  │  MQTT数据    │          │
│  │  关系型数据   │  │  缓存/队列   │  │  消息存储     │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
└─────────────────────────────────────────────────────────────────┘
```

## 技术栈

### 前端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| **Vue 3** | ^3.4.0 | 前端框架 |
| **Vite** | ^5.0.0 | 构建工具 |
| **Element Plus** | ^2.5.0 | UI 组件库 |
| **Vue Router** | ^4.3.0 | 路由管理 |
| **Pinia** | ^2.1.7 | 状态管理 |
| **Axios** | ^1.6.0 | HTTP 客户端 |
| **ECharts** | ^6.0.0 | 数据可视化 |
| **Vue Flow** | ^1.33.0 | 流程图编辑 |
| **Marked** | ^11.0.0 | Markdown 渲染 |

### 后端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| **Python** | 3.11 | 编程语言 |
| **FastAPI** | 0.104.1 | Web 框架 |
| **Uvicorn** | 0.24.0 | ASGI 服务器 |
| **SQLAlchemy** | 2.0.23 | ORM 框架 |
| **PyMySQL** | 1.1.0 | MySQL 驱动 |
| **Pydantic** | 2.5.0 | 数据验证 |
| **python-jose** | 3.3.0 | JWT 处理 |
| **passlib** | 1.7.4 | 密码加密 |
| **Celery** | 5.3.4 | 异步任务队列 |
| **Redis** | 5.0.1 | 缓存客户端 |

### 基础设施

| 技术 | 版本 | 用途 |
|------|------|------|
| **MySQL** | 8.0 | 关系型数据库 |
| **Redis** | 7-alpine | 缓存/消息队列 |
| **Mosquitto** | 2.0 | MQTT 消息代理 |
| **Nginx** | latest | 反向代理/静态服务 |
| **Docker** | 20+ | 容器化 |
| **Docker Compose** | 3.8 | 容器编排 |

## 架构特点

### 1. 微服务架构

系统采用微服务架构，各服务独立部署、独立扩展：

```
├── backend              # 主后端服务
├── service/
│   ├── mqtt-service     # MQTT 物联网通信服务
│   ├── celery-service   # 异步任务服务
│   ├── plugin-service   # AI 插件服务
│   ├── plugin-backend-service  # 插件后端服务
│   └── config-service   # 配置管理服务
└── frontend             # 前端服务
```

**优势**：
- ✅ 服务独立部署，互不影响
- ✅ 可按需扩展特定服务
- ✅ 技术栈灵活选择
- ✅ 故障隔离

### 2. 前后端分离

前端和后端完全解耦，通过 RESTful API 通信：

```
前端 (Vue 3)  <──── HTTP/HTTPS ────>  后端 (FastAPI)
     │                                      │
     │                                      │
  浏览器渲染                            业务逻辑 + 数据库
```

**优势**：
- ✅ 前后端独立开发
- ✅ 前端可部署到 CDN
- ✅ 支持多端复用（Web、移动端）
- ✅ API 可被第三方集成

### 3. 容器化部署

所有服务使用 Docker 容器化：

```yaml
# docker-compose.yml
services:
  mysql:
    image: mysql:8.0
  redis:
    image: redis:7-alpine
  mqtt:
    image: eclipse-mosquitto:2.0
  backend:
    build: ./backend
  frontend:
    build: ./frontend
```

**优势**：
- ✅ 环境一致性
- ✅ 快速部署
- ✅ 易于扩展
- ✅ 版本管理

### 4. 异步任务处理

使用 Celery + Redis 处理耗时任务：

```
API请求 ──> FastAPI ──> 创建任务 ──> Redis队列
                                        │
                                        ↓
                            Celery Worker 执行任务
                                        │
                                        ↓
                                    更新结果
```

**应用场景**：
- 文档向量化
- 邮件发送
- 数据分析
- 视频处理

### 5. 物联网通信

基于 MQTT 协议的设备通信：

```
ESP32设备 <──── MQTT ────> Mosquitto Broker <──── MQTT ────> 后端服务
                                  │
                                  └────> 消息订阅/发布
```

**特点**：
- ✅ 轻量级协议
- ✅ 支持海量设备
- ✅ 双向通信
- ✅ QoS 保证

## 核心模块

### 1. 用户认证模块

```
登录请求 ──> 验证用户名密码 ──> 生成JWT Token ──> 返回Token
                                      │
                                      ↓
后续请求 ──> 验证Token ──> 提取用户信息 ──> 执行业务逻辑
```

**技术**：JWT + bcrypt + OAuth2

**详见**：[认证授权文档](../01_认证授权/)

### 2. AI 智能体模块

```
用户对话 ──> 意图识别 ──> 知识库检索 ──> LLM生成 ──> 插件调用 ──> 返回结果
```

**支持的 LLM**：
- Deepseek
- 通义千问
- 文心一言
- 智谱 GLM
- Kimi
- 混元
- 豆包

### 3. 设备管理模块

```
设备注册 ──> 设备认证 ──> 设备绑定 ──> 设备控制 ──> 数据上报
```

**功能**：
- 设备注册/认证
- 设备分组管理
- 设备授权（PBL 场景）
- OTA 固件升级

### 4. PBL 教学模块

```
创建课程 ──> 创建班级 ──> 创建任务 ──> 学生提交 ──> 教师评价
```

**角色**：
- 系统管理员
- 渠道管理员
- 教师
- 学生

### 5. 知识库模块

```
上传文档 ──> 文档解析 ──> 分块 ──> 向量化 ──> 存储 ──> 检索
```

**支持格式**：
- PDF
- Word
- Markdown
- TXT
- Excel

## 数据流

### 用户请求流程

```
1. 用户在浏览器发起请求
   ↓
2. Nginx 接收请求
   ↓ 静态资源？
   ├─ 是 → 直接返回静态文件
   └─ 否 → 转发到后端
       ↓
3. FastAPI 接收请求
   ↓
4. JWT 认证中间件验证 Token
   ↓
5. 路由处理器执行业务逻辑
   ↓
6. SQLAlchemy 操作数据库
   ↓
7. 返回统一格式响应
   ↓
8. 前端接收并渲染
```

### 设备通信流程

```
1. ESP32 设备连接 MQTT Broker
   ↓
2. 订阅主题: device/{device_id}/command
   ↓
3. 后端发布控制命令到主题
   ↓
4. 设备接收命令并执行
   ↓
5. 设备发布状态到: device/{device_id}/status
   ↓
6. 后端订阅状态主题并更新数据库
```

## 部署架构

### 开发环境

```
├── 前端: npm run dev (端口 3000)
├── 后端: uvicorn main:app (端口 8000)
├── MySQL: 本地 Docker (端口 3306)
├── Redis: 本地 Docker (端口 6379)
└── MQTT: 本地 Docker (端口 1883)
```

### 生产环境

```
Internet
   ↓
Nginx (443)
   ↓
   ├─ /api/* ──> Backend Container (8000)
   ├─ /mqtt ───> MQTT Container (1883)
   └─ /* ──────> Frontend Static Files
   
Backend Container
   ↓
   ├─ MySQL Container (3306)
   ├─ Redis Container (6379)
   └─ MQTT Container (1883)
```

**特点**：
- ✅ HTTPS 加密传输
- ✅ Nginx 反向代理
- ✅ 容器网络隔离
- ✅ 数据持久化

## 性能优化

### 1. 数据库优化

```sql
-- 索引优化
CREATE INDEX idx_user_email ON core_users(email);
CREATE INDEX idx_device_user ON devices(user_id);

-- 查询优化
-- 使用 JOIN 代替多次查询
-- 使用 LIMIT 分页
```

### 2. 缓存策略

```python
# Redis 缓存
@cache.cached(timeout=300, key_prefix='user_info')
def get_user_info(user_id):
    return db.query(User).filter(User.id == user_id).first()
```

### 3. 前端优化

```javascript
// 路由懒加载
const Dashboard = () => import('./views/Dashboard.vue')

// 组件懒加载
components: {
  HeavyComponent: () => import('./HeavyComponent.vue')
}

// 图片懒加载
<img v-lazy="imageUrl" />
```

### 4. API 优化

```python
# 批量操作
@router.post("/devices/batch")
async def batch_create_devices(devices: List[DeviceCreate]):
    db.bulk_insert_mappings(Device, devices)

# 分页查询
@router.get("/devices")
async def list_devices(page: int = 1, size: int = 20):
    return paginate(Device, page, size)
```

## 监控与日志

### 日志级别

```python
# 开发环境
logging.basicConfig(level=logging.DEBUG)

# 生产环境
logging.basicConfig(level=logging.INFO)
```

### 健康检查

```python
@app.get("/health")
async def health_check():
    return {
        "status": "healthy",
        "database": check_database(),
        "redis": check_redis(),
        "mqtt": check_mqtt()
    }
```

### Docker 健康检查

```yaml
healthcheck:
  test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
  interval: 30s
  timeout: 10s
  retries: 3
```

## 安全措施

### 1. 认证授权

- ✅ JWT Token 认证
- ✅ 角色权限控制
- ✅ API 访问限制

### 2. 数据安全

- ✅ 密码 bcrypt 加密
- ✅ HTTPS 传输加密
- ✅ SQL 注入防护

### 3. 网络安全

- ✅ CORS 跨域限制
- ✅ 请求频率限制
- ✅ 容器网络隔离

## 扩展性设计

### 水平扩展

```yaml
# 多实例部署
services:
  backend:
    deploy:
      replicas: 3  # 3个后端实例
  
  nginx:
    # 负载均衡
    upstream backend {
      server backend1:8000;
      server backend2:8000;
      server backend3:8000;
    }
```

### 垂直扩展

```yaml
# 增加资源限制
services:
  backend:
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
```

## 技术决策

### 为什么选择 FastAPI？

- ✅ 高性能（基于 Starlette 和 Pydantic）
- ✅ 自动生成 API 文档
- ✅ 类型提示支持
- ✅ 异步支持

### 为什么选择 Vue 3？

- ✅ 组合式 API 更灵活
- ✅ 性能提升
- ✅ TypeScript 支持更好
- ✅ 生态丰富

### 为什么选择 MQTT？

- ✅ 物联网标准协议
- ✅ 轻量级、低功耗
- ✅ 支持海量设备连接
- ✅ 双向实时通信

## 相关文档

- [前端架构](./前端架构.md) - Vue 3 前端详细设计
- [后端架构](./后端架构.md) - FastAPI 后端详细设计
- [数据库设计](./数据库设计.md) - MySQL 数据库结构
- [微服务架构](./微服务架构.md) - 独立服务模块设计
- [Docker容器化部署](../03_部署运维/Docker容器化部署.md) - 容器化部署方案
